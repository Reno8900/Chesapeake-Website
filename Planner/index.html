<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Portfolio Planner | Chesapeake Systems</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',-apple-system,sans-serif;background:#0a0a0a;color:#fff;min-height:100vh}
    .loading{display:flex;align-items:center;justify-content:center;min-height:100vh;flex-direction:column;gap:16px}
    .spinner{width:40px;height:40px;border:3px solid #222;border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    ::-webkit-scrollbar{width:8px;height:8px}
    ::-webkit-scrollbar-track{background:#111}
    ::-webkit-scrollbar-thumb{background:#333;border-radius:4px}
    input:focus,select:focus,button:focus{outline:2px solid #fff;outline-offset:2px}
    .rbar{position:absolute;height:44px;border-radius:6px;display:flex;align-items:center;padding:0 12px;justify-content:space-between;cursor:grab;user-select:none}
    .rbar:hover{box-shadow:0 0 0 2px rgba(255,255,255,0.3)}
    .rbar.drag{cursor:grabbing;box-shadow:0 0 0 2px #fff;z-index:100}
    .rh{position:absolute;top:0;bottom:0;width:12px;cursor:ew-resize}
    .rh::after{content:'';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:3px;height:20px;background:rgba(255,255,255,0.3);border-radius:2px}
    .rbar:hover .rh::after{background:rgba(255,255,255,0.6)}
    .rh-l{left:0}.rh-r{right:0}
    .tooltip{position:relative;display:inline-flex}
    .tooltip .tip{visibility:hidden;position:absolute;top:100%;right:0;margin-top:8px;padding:12px 16px;background:#1a1a1a;border:1px solid #333;border-radius:8px;font-size:13px;color:#ccc;width:250px;z-index:1000;line-height:1.5}
    .tooltip:hover .tip{visibility:visible}
    .dropdown{position:relative}
    .dropdown-menu{position:absolute;top:100%;right:0;margin-top:8px;background:#1a1a1a;border:1px solid #333;border-radius:8px;min-width:220px;z-index:1000;overflow:hidden}
    .dropdown-item{padding:12px 16px;cursor:pointer;display:flex;align-items:center;gap:10px;font-size:14px;color:#ccc;border-bottom:1px solid #222}
    .dropdown-item:last-child{border-bottom:none}
    .dropdown-item:hover{background:#222;color:#fff}
  </style>
</head>
<body>
<div id="root"><div class="loading"><div class="spinner"></div><span style="color:#666">Loading...</span></div></div>
<script type="text/babel">
const SUPABASE_URL='https://lzmstiaexrelqviksdjt.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx6bXN0aWFleHJlbHF2aWtzZGp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1OTA3MDAsImV4cCI6MjA4NDE2NjcwMH0.Ys-BX1yVk-31xQg5hUsyBxvFTHPyaocbOsuUvXXxf-k';
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
const C={bg:'#0a0a0a',card:'#111',border:'#222',borderL:'#333',text:'#fff',textS:'#999',textM:'#666',capex:'#3b82f6',opex:'#ec4899',fte:'#22c55e',con:'#f97316',err:'#ef4444',ok:'#22c55e',accent:'#3b82f6'};
const RTS=[{id:'developer',name:'Developer',color:'#3B82F6',rate:150},{id:'designer',name:'Designer',color:'#EC4899',rate:125},{id:'pm',name:'Project Manager',color:'#10B981',rate:130},{id:'analyst',name:'Analyst',color:'#F59E0B',rate:110},{id:'qa',name:'QA Engineer',color:'#8B5CF6',rate:100},{id:'devops',name:'DevOps',color:'#EF4444',rate:140},{id:'architect',name:'Architect',color:'#06b6d4',rate:175}];
const CCS=[{id:'software',name:'Software & Licensing',ct:'capex',tm:'lump'},{id:'hardware',name:'Hardware',ct:'capex',tm:'lump'},{id:'cloud',name:'Cloud & Hosting',ct:'opex',tm:'recurring'},{id:'training',name:'Training',ct:'capex',tm:'lump'},{id:'travel',name:'Travel',ct:'opex',tm:'lump'},{id:'migration',name:'Data Migration',ct:'capex',tm:'lump'},{id:'security',name:'Security & Compliance',ct:'opex',tm:'lump'},{id:'maintenance',name:'Maintenance & Support',ct:'opex',tm:'recurring'},{id:'contingency',name:'Contingency',ct:'capex',tm:'lump'},{id:'other',name:'Other',ct:'opex',tm:'lump'}];
const FYS=['FY2024','FY2025','FY2026','FY2027','FY2028'];
const PCOLS=['#3B82F6','#10B981','#F59E0B','#EF4444','#8B5CF6','#EC4899','#06b6d4','#84cc16'];
const HPM=160;
const fmt=n=>new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:0,maximumFractionDigits:0}).format(n);
const addM=(d,m)=>{const r=new Date(d);r.setMonth(r.getMonth()+m);return r};
const fmtM=d=>d.toLocaleDateString('en-US',{month:'short',year:'numeric'});
const cCost=r=>r.rate*r.duration_periods*HPM*r.quantity*(r.allocation/100);
const cHrs=r=>r.duration_periods*HPM*r.quantity*(r.allocation/100);
const useWin=()=>{const[w,sW]=React.useState(window.innerWidth);React.useEffect(()=>{const h=()=>sW(window.innerWidth);window.addEventListener('resize',h);return()=>window.removeEventListener('resize',h)},[]);return{w,mob:w<768,tab:w>=768&&w<1024}};

const SLIDES=[{icon:'üëã',title:'Welcome to Portfolio Planner',desc:'Plan resources, track costs, and manage your entire project portfolio in one place.'},{icon:'üìÅ',title:'Create Projects',desc:'Click "+ New Project" to get started. Each project has its own timeline, resources, and budget.'},{icon:'üë•',title:'Add Resources',desc:'Add team members to the timeline. Drag to move, drag edges to resize. Double-click to edit.'},{icon:'üí∞',title:'Track Costs',desc:'Switch to Budget view to add vendors and other costs. Everything is categorized as CAPEX or OPEX.'},{icon:'ü§ù',title:'Team Collaboration',desc:'Click "Team" to invite colleagues. They can view or edit based on their role.'},{icon:'üìä',title:'Reports',desc:'Click "Report" for budget summaries and CSV export.'}];

const AuthCtx=React.createContext(null);
const AuthProvider=({children})=>{
  const[user,setUser]=React.useState(null);
  const[profile,setProfile]=React.useState(null);
  const[org,setOrg]=React.useState(null);
  const[loading,setLoading]=React.useState(true);
  const[showTutorial,setShowTutorial]=React.useState(false);
  const loadData=async(uid)=>{
    const{data:p}=await supabase.from('profiles').select('*').eq('id',uid).single();
    setProfile(p);
    const{data:orgs}=await supabase.from('organizations').select('*').order('created_at');
    if(orgs?.length){setOrg(orgs[0]);if(!localStorage.getItem('pp_tutorial'))setShowTutorial(true)}
    setLoading(false);
  };
  React.useEffect(()=>{
    supabase.auth.getSession().then(({data:{session}})=>{
      setUser(session?.user??null);
      if(session?.user)loadData(session.user.id);else setLoading(false);
    });
    const{data:{subscription}}=supabase.auth.onAuthStateChange((e,session)=>{
      setUser(session?.user??null);
      if(session?.user)loadData(session.user.id);else{setProfile(null);setOrg(null);setLoading(false);}
    });
    return()=>subscription.unsubscribe();
  },[]);
  const signUp=async(email,pw,name)=>{const{error}=await supabase.auth.signUp({email,password:pw,options:{data:{full_name:name},emailRedirectTo:window.location.origin+window.location.pathname}});if(error)throw error};
  const signIn=async(email,pw)=>{const{error}=await supabase.auth.signInWithPassword({email,password:pw});if(error)throw error};
  const signOut=()=>supabase.auth.signOut();
  const resetPw=async(email)=>{const{error}=await supabase.auth.resetPasswordForEmail(email,{redirectTo:window.location.origin+window.location.pathname});if(error)throw error};
  const updatePw=async(pw)=>{const{error}=await supabase.auth.updateUser({password:pw});if(error)throw error};
  const createOrg=async(name,logo)=>{const{data,error}=await supabase.from('organizations').insert({name,logo_url:logo||null,owner_id:user.id}).select().single();if(error)throw error;setOrg(data);setShowTutorial(true);return data};
  const updateOrg=async(u)=>{const{data,error}=await supabase.from('organizations').update(u).eq('id',org.id).select().single();if(error)throw error;setOrg(data)};
  const closeTutorial=()=>{localStorage.setItem('pp_tutorial','1');setShowTutorial(false)};
  const openTutorial=()=>setShowTutorial(true);
  return<AuthCtx.Provider value={{user,profile,org,loading,signUp,signIn,signOut,resetPw,updatePw,createOrg,updateOrg,showTutorial,closeTutorial,openTutorial}}>{children}</AuthCtx.Provider>;
};
const useAuth=()=>React.useContext(AuthCtx);

const useProjects=(orgId)=>{
  const[projects,setProjects]=React.useState([]);
  const[loading,setLoading]=React.useState(true);
  const fetch=async()=>{if(!orgId)return;setLoading(true);const{data}=await supabase.from('projects').select('*,resources(*),vendor_services(*),other_costs(*)').eq('organization_id',orgId).order('created_at');setProjects(data||[]);setLoading(false)};
  React.useEffect(()=>{fetch()},[orgId]);
  const create=async(p)=>{const{data,error}=await supabase.from('projects').insert({...p,organization_id:orgId}).select().single();if(error)throw error;setProjects(prev=>[...prev,{...data,resources:[],vendor_services:[],other_costs:[]}]);return data};
  const del=async(id)=>{const{error}=await supabase.from('projects').delete().eq('id',id);if(error)throw error;setProjects(prev=>prev.filter(p=>p.id!==id))};
  const addRes=async(pid,r)=>{const{data,error}=await supabase.from('resources').insert({...r,project_id:pid}).select().single();if(error)throw error;setProjects(prev=>prev.map(p=>p.id===pid?{...p,resources:[...(p.resources||[]),data]}:p))};
  const updateRes=async(pid,rid,u)=>{const{error}=await supabase.from('resources').update(u).eq('id',rid);if(error)throw error;setProjects(prev=>prev.map(p=>p.id===pid?{...p,resources:p.resources.map(r=>r.id===rid?{...r,...u}:r)}:p))};
  const delRes=async(pid,rid)=>{await supabase.from('resources').delete().eq('id',rid);setProjects(prev=>prev.map(p=>p.id===pid?{...p,resources:p.resources.filter(r=>r.id!==rid)}:p))};
  const addVen=async(pid,v)=>{const{data,error}=await supabase.from('vendor_services').insert({...v,project_id:pid}).select().single();if(error)throw error;setProjects(prev=>prev.map(p=>p.id===pid?{...p,vendor_services:[...(p.vendor_services||[]),data]}:p))};
  const updateVen=async(pid,vid,u)=>{const{error}=await supabase.from('vendor_services').update(u).eq('id',vid);if(error)throw error;setProjects(prev=>prev.map(p=>p.id===pid?{...p,vendor_services:p.vendor_services.map(v=>v.id===vid?{...v,...u}:v)}:p))};
  const delVen=async(pid,vid)=>{await supabase.from('vendor_services').delete().eq('id',vid);setProjects(prev=>prev.map(p=>p.id===pid?{...p,vendor_services:p.vendor_services.filter(v=>v.id!==vid)}:p))};
  const addCost=async(pid,c)=>{const{data,error}=await supabase.from('other_costs').insert({...c,project_id:pid}).select().single();if(error)throw error;setProjects(prev=>prev.map(p=>p.id===pid?{...p,other_costs:[...(p.other_costs||[]),data]}:p))};
  const updateCost=async(pid,cid,u)=>{const{error}=await supabase.from('other_costs').update(u).eq('id',cid);if(error)throw error;setProjects(prev=>prev.map(p=>p.id===pid?{...p,other_costs:p.other_costs.map(c=>c.id===cid?{...c,...u}:c)}:p))};
  const delCost=async(pid,cid)=>{await supabase.from('other_costs').delete().eq('id',cid);setProjects(prev=>prev.map(p=>p.id===pid?{...p,other_costs:p.other_costs.filter(c=>c.id!==cid)}:p))};
  return{projects,loading,create,del,addRes,updateRes,delRes,addVen,updateVen,delVen,addCost,updateCost,delCost,refresh:fetch};
};

const useTeam=(orgId)=>{
  const[members,setMembers]=React.useState([]);
  const[invites,setInvites]=React.useState([]);
  const fetch=async()=>{if(!orgId)return;const{data:m}=await supabase.from('organization_members').select('*,profiles(*)').eq('organization_id',orgId);setMembers(m||[]);const{data:i}=await supabase.from('invitations').select('*').eq('organization_id',orgId).eq('status','pending');setInvites(i||[])};
  React.useEffect(()=>{fetch()},[orgId]);
  const invite=async(email,role='member')=>{const{data,error}=await supabase.from('invitations').insert({organization_id:orgId,email,role,status:'pending'}).select().single();if(error)throw error;setInvites(prev=>[...prev,data])};
  const cancelInvite=async(id)=>{await supabase.from('invitations').delete().eq('id',id);setInvites(prev=>prev.filter(i=>i.id!==id))};
  const removeMember=async(uid)=>{await supabase.from('organization_members').delete().eq('organization_id',orgId).eq('user_id',uid);setMembers(prev=>prev.filter(m=>m.user_id!==uid))};
  return{members,invites,invite,cancelInvite,removeMember,refresh:fetch};
};

const Modal=({open,onClose,title,children,wide})=>{if(!open)return null;return<div style={{position:'fixed',inset:0,background:'rgba(0,0,0,.9)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:1000,padding:16}} onClick={onClose}><div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,width:'100%',maxWidth:wide?700:500,maxHeight:'90vh',overflow:'auto'}} onClick={e=>e.stopPropagation()}><div style={{padding:'20px 24px',borderBottom:`1px solid ${C.border}`,display:'flex',justifyContent:'space-between',alignItems:'center'}}><h3 style={{margin:0,fontSize:18,fontWeight:600}}>{title}</h3><button onClick={onClose} style={{background:'transparent',border:'none',color:C.textS,fontSize:24,cursor:'pointer'}}>√ó</button></div><div style={{padding:24}}>{children}</div></div></div>};
const Btn=({children,onClick,v='primary',disabled,style,...p})=>{const S={primary:{background:C.text,color:C.bg},secondary:{background:'transparent',color:C.text,border:`1px solid ${C.border}`},danger:{background:C.err,color:'#fff'},accent:{background:C.accent,color:'#fff'}};return<button onClick={onClick} disabled={disabled} style={{padding:'12px 24px',borderRadius:8,fontSize:14,fontWeight:600,cursor:disabled?'not-allowed':'pointer',opacity:disabled?.5:1,border:'none',...S[v],...style}} {...p}>{children}</button>};
const Input=({label,...p})=><div style={{marginBottom:16}}>{label&&<label style={{fontSize:12,color:C.textS,marginBottom:6,display:'block',textTransform:'uppercase',letterSpacing:.5}}>{label}</label>}<input {...p} style={{width:'100%',padding:12,background:C.bg,border:`1px solid ${C.border}`,borderRadius:6,color:C.text,fontSize:14,...p.style}}/></div>;
const Select=({label,children,...p})=><div style={{marginBottom:16}}>{label&&<label style={{fontSize:12,color:C.textS,marginBottom:6,display:'block',textTransform:'uppercase',letterSpacing:.5}}>{label}</label>}<select {...p} style={{width:'100%',padding:12,background:C.bg,border:`1px solid ${C.border}`,borderRadius:6,color:C.text,fontSize:14,...p.style}}>{children}</select></div>;
const Tooltip=({text,children})=><div className="tooltip">{children}<div className="tip">{text}</div></div>;

const Tutorial=({onClose})=>{const[s,setS]=React.useState(0);const sl=SLIDES[s];return<div style={{position:'fixed',inset:0,background:'rgba(0,0,0,.95)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:2000,padding:20}}><div style={{background:'linear-gradient(145deg,#1a1a2e,#0f0f1a)',border:`1px solid ${C.border}`,borderRadius:16,width:'100%',maxWidth:480,padding:'48px 40px',textAlign:'center'}}><div style={{fontSize:56,marginBottom:20}}>{sl.icon}</div><h2 style={{fontSize:22,marginBottom:12}}>{sl.title}</h2><p style={{color:C.textS,lineHeight:1.6,marginBottom:32}}>{sl.desc}</p><div style={{display:'flex',gap:6,justifyContent:'center',marginBottom:28}}>{SLIDES.map((_,i)=><div key={i} style={{width:8,height:8,borderRadius:4,background:i===s?C.accent:C.border}}/>)}</div><div style={{display:'flex',gap:12,justifyContent:'center'}}>{s>0&&<Btn v="secondary" onClick={()=>setS(s-1)}>Back</Btn>}{s<SLIDES.length-1&&<Btn v="secondary" onClick={()=>{onClose();localStorage.setItem('pp_tutorial','1')}}>Skip</Btn>}<Btn v="accent" onClick={()=>s===SLIDES.length-1?onClose():setS(s+1)}>{s===SLIDES.length-1?'Get Started':'Next'}</Btn></div>{s<SLIDES.length-1&&<p style={{fontSize:12,color:C.textM,marginTop:16}}>Find this later in Settings</p>}</div></div>};

const RBar=({r,idx,periods,onUpd,onDel,onEdit,color,showAll})=>{const ref=React.useRef(null);const[drag,setDrag]=React.useState(false);const[resize,setResize]=React.useState(null);const[start,setStart]=React.useState({x:0,sp:0,dur:0,pw:0});const down=(e,type)=>{e.preventDefault();e.stopPropagation();if(showAll)return;const rect=ref.current.parentElement.getBoundingClientRect();setStart({x:e.clientX,sp:r.start_period,dur:r.duration_periods,pw:rect.width/periods});type==='move'?setDrag(true):setResize(type)};React.useEffect(()=>{if(!drag&&!resize)return;const move=e=>{const dx=e.clientX-start.x;const dp=Math.round(dx/start.pw);if(drag){const ns=Math.max(0,Math.min(periods-start.dur,start.sp+dp));if(ns!==r.start_period)onUpd(r.id,{start_period:ns})}else if(resize==='left'){const ns=Math.max(0,Math.min(start.sp+start.dur-1,start.sp+dp));const nd=start.dur-(ns-start.sp);if(ns!==r.start_period||nd!==r.duration_periods)onUpd(r.id,{start_period:ns,duration_periods:nd})}else{const nd=Math.max(1,Math.min(periods-start.sp,start.dur+dp));if(nd!==r.duration_periods)onUpd(r.id,{duration_periods:nd})}};const up=()=>{setDrag(false);setResize(null)};window.addEventListener('mousemove',move);window.addEventListener('mouseup',up);return()=>{window.removeEventListener('mousemove',move);window.removeEventListener('mouseup',up)}},[drag,resize]);return<div ref={ref} className={`rbar${drag?' drag':''}`} style={{top:`${idx*54+10}px`,left:`${(r.start_period/periods)*100}%`,width:`${(r.duration_periods/periods)*100}%`,background:`${color}20`,border:`1px solid ${color}`}} onMouseDown={e=>down(e,'move')} onDoubleClick={()=>!showAll&&onEdit(r)}>{!showAll&&<div className="rh rh-l" onMouseDown={e=>down(e,'left')}/>}<div style={{display:'flex',alignItems:'center',gap:6,overflow:'hidden',flex:1,paddingLeft:8}}><span style={{fontSize:12,fontWeight:500,whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis'}}>{r.name}</span>{r.quantity>1&&<span style={{background:color,color:'#fff',fontSize:9,fontWeight:600,padding:'2px 5px',borderRadius:3}}>√ó{r.quantity}</span>}<span style={{background:r.employment_type==='fte'?`${C.fte}40`:`${C.con}40`,color:r.employment_type==='fte'?C.fte:C.con,fontSize:9,fontWeight:600,padding:'2px 5px',borderRadius:3}}>{r.employment_type==='fte'?'FTE':'CON'}</span></div><div style={{display:'flex',alignItems:'center',gap:8,paddingRight:8}}><span style={{fontSize:11,fontWeight:600,color}}>{fmt(cCost(r))}</span>{!showAll&&<button onClick={e=>{e.stopPropagation();onDel(r.id)}} style={{background:'transparent',border:'none',color:C.textM,cursor:'pointer',fontSize:14}}>√ó</button>}</div>{!showAll&&<div className="rh rh-r" onMouseDown={e=>down(e,'right')}/>}</div>};

const Landing=({onStart})=>{const{mob}=useWin();return<div style={{minHeight:'100vh',background:C.bg}}><nav style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:mob?'16px 20px':'20px 48px',borderBottom:`1px solid ${C.border}`}}><span style={{fontSize:mob?16:20,fontWeight:600}}>Portfolio Planner</span><Btn onClick={onStart}>Sign In</Btn></nav><section style={{padding:mob?'60px 20px':'100px 48px',textAlign:'center',maxWidth:900,margin:'0 auto'}}><h1 style={{fontSize:mob?32:52,fontWeight:600,lineHeight:1.15,marginBottom:24}}>Plan resources. Control costs.<br/>Deliver with confidence.</h1><p style={{fontSize:mob?16:18,color:C.textS,maxWidth:700,margin:'0 auto 48px',lineHeight:1.7}}>Complete visibility into project costs, FTE and consultant allocation, CAPEX and OPEX‚Äîfor one project or an entire portfolio.</p><Btn onClick={onStart} style={{padding:'16px 40px',fontSize:16}}>Start Free Trial</Btn><p style={{fontSize:14,color:C.textM,marginTop:16}}>14-day free trial ¬∑ No credit card</p></section><footer style={{padding:'40px 20px',borderTop:`1px solid ${C.border}`,textAlign:'center'}}><div style={{color:C.textM,fontSize:14}}>¬© 2025 Chesapeake Systems ¬∑ <a href="#" style={{color:C.textM}}>Privacy</a> ¬∑ <a href="#" style={{color:C.textM}}>Terms</a></div></footer></div>};

const AuthPage=({onBack})=>{const{signIn,signUp,resetPw}=useAuth();const[mode,setMode]=React.useState('signin');const[email,setEmail]=React.useState('');const[pw,setPw]=React.useState('');const[name,setName]=React.useState('');const[err,setErr]=React.useState('');const[ok,setOk]=React.useState('');const[ld,setLd]=React.useState(false);const go=async e=>{e.preventDefault();setErr('');setOk('');setLd(true);try{if(mode==='signup'){await signUp(email,pw,name);setOk('Check email')}else if(mode==='forgot'){await resetPw(email);setOk('Reset sent!')}else await signIn(email,pw)}catch(e){setErr(e.message)}setLd(false)};return<div style={{minHeight:'100vh',background:C.bg,display:'flex',alignItems:'center',justifyContent:'center',padding:20}}><div style={{width:'100%',maxWidth:400}}><div style={{textAlign:'center',marginBottom:32}}><h1 style={{fontSize:24,fontWeight:600,marginBottom:8}}>Portfolio Planner</h1><p style={{color:C.textS}}>{mode==='signin'?'Sign in':mode==='signup'?'Create account':'Reset password'}</p></div><div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:32}}>{err&&<div style={{background:`${C.err}20`,border:`1px solid ${C.err}`,borderRadius:6,padding:12,marginBottom:16,fontSize:14,color:C.err}}>{err}</div>}{ok&&<div style={{background:`${C.ok}20`,border:`1px solid ${C.ok}`,borderRadius:6,padding:12,marginBottom:16,fontSize:14,color:C.ok}}>{ok}</div>}<form onSubmit={go}>{mode==='signup'&&<Input label="Name" value={name} onChange={e=>setName(e.target.value)} required/>}<Input label="Email" type="email" value={email} onChange={e=>setEmail(e.target.value)} required/>{mode!=='forgot'&&<Input label="Password" type="password" value={pw} onChange={e=>setPw(e.target.value)} required minLength={6}/>}<Btn type="submit" disabled={ld} style={{width:'100%',marginTop:8}}>{ld?'...':mode==='signin'?'Sign In':mode==='signup'?'Create':'Send Reset'}</Btn></form><div style={{marginTop:24,textAlign:'center'}}>{mode==='signin'?<><p style={{marginBottom:8}}><button onClick={()=>setMode('forgot')} style={{background:'none',border:'none',color:C.text,textDecoration:'underline',cursor:'pointer'}}>Forgot password?</button></p><p style={{color:C.textS}}>No account? <button onClick={()=>setMode('signup')} style={{background:'none',border:'none',color:C.text,textDecoration:'underline',cursor:'pointer'}}>Sign up</button></p></>:<button onClick={()=>setMode('signin')} style={{background:'none',border:'none',color:C.text,textDecoration:'underline',cursor:'pointer'}}>Back to sign in</button>}</div></div><div style={{textAlign:'center',marginTop:24}}><button onClick={onBack} style={{background:'none',border:'none',color:C.textM,cursor:'pointer'}}>‚Üê Home</button></div></div></div>};

const Onboarding=()=>{const{createOrg,profile,signOut}=useAuth();const{mob}=useWin();const[name,setName]=React.useState('');const[logo,setLogo]=React.useState('');const[agreed,setAgreed]=React.useState(false);const[ld,setLd]=React.useState(false);const[err,setErr]=React.useState('');const go=async e=>{e.preventDefault();if(!name.trim()||!agreed)return;setLd(true);setErr('');try{await createOrg(name.trim(),logo)}catch(e){setErr(e.message);setLd(false)}};return<div style={{minHeight:'100vh',background:C.bg}}><nav style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:mob?'16px 20px':'20px 48px',borderBottom:`1px solid ${C.border}`}}><span style={{fontSize:mob?16:20,fontWeight:600}}>Portfolio Planner</span><Btn v="secondary" onClick={signOut} style={{padding:'8px 16px'}}>Sign Out</Btn></nav><div style={{display:'flex',alignItems:'center',justifyContent:'center',padding:20,minHeight:'calc(100vh - 73px)'}}><div style={{width:'100%',maxWidth:450,textAlign:'center'}}><h1 style={{fontSize:28,fontWeight:600,marginBottom:8}}>Welcome{profile?.full_name?`, ${profile.full_name}`:''}!</h1><p style={{color:C.textS,marginBottom:32}}>Set up your organization.</p><div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:32,textAlign:'left'}}>{err&&<div style={{background:`${C.err}20`,border:`1px solid ${C.err}`,borderRadius:6,padding:12,marginBottom:16,fontSize:14,color:C.err}}>{err}</div>}<form onSubmit={go}><Input label="Organization Name" value={name} onChange={e=>setName(e.target.value)} placeholder="Acme Inc" required/><Input label="Logo URL (optional)" value={logo} onChange={e=>setLogo(e.target.value)} placeholder="https://..."/><div style={{marginBottom:20,padding:16,background:C.bg,borderRadius:8}}><label style={{display:'flex',alignItems:'flex-start',gap:12,cursor:'pointer'}}><input type="checkbox" checked={agreed} onChange={e=>setAgreed(e.target.checked)} style={{marginTop:4,width:18,height:18}}/><span style={{fontSize:13,color:C.textS,lineHeight:1.5}}>I agree to the <a href="#" style={{color:C.accent}} onClick={e=>{e.preventDefault();alert('EULA coming soon')}}>EULA</a> and <a href="#" style={{color:C.accent}} onClick={e=>{e.preventDefault();alert('Privacy Policy coming soon')}}>Privacy Policy</a></span></label></div><Btn type="submit" disabled={ld||!name.trim()||!agreed} style={{width:'100%'}}>{ld?'...':'Create Organization'}</Btn></form></div></div></div></div>};

const Settings=({open,onClose})=>{const{profile,org,signOut,updatePw,updateOrg,openTutorial}=useAuth();const[v,setV]=React.useState('main');const[pw,setPw]=React.useState('');const[oName,setOName]=React.useState(org?.name||'');const[oLogo,setOLogo]=React.useState(org?.logo_url||'');const[ld,setLd]=React.useState(false);const[msg,setMsg]=React.useState('');React.useEffect(()=>{if(org){setOName(org.name);setOLogo(org.logo_url||'')}},[org]);const savePw=async()=>{if(pw.length<6)return setMsg('Min 6 chars');setLd(true);try{await updatePw(pw);setMsg('Updated!');setPw('')}catch(e){setMsg(e.message)}setLd(false)};const saveOrg=async()=>{setLd(true);try{await updateOrg({name:oName,logo_url:oLogo||null});setMsg('Saved!')}catch(e){setMsg(e.message)}setLd(false)};if(!open)return null;return<Modal open={open} onClose={onClose} title="Settings">{v==='main'&&<div><div style={{marginBottom:12,padding:16,background:C.bg,borderRadius:8}}><div style={{fontSize:12,color:C.textM}}>Signed in as</div><div style={{fontWeight:500}}>{profile?.email}</div></div><div style={{display:'flex',flexDirection:'column',gap:4}}><button onClick={()=>setV('pw')} style={{padding:14,background:'transparent',border:'none',color:C.text,textAlign:'left',cursor:'pointer',borderRadius:6}}>üîê Change Password</button><button onClick={()=>setV('org')} style={{padding:14,background:'transparent',border:'none',color:C.text,textAlign:'left',cursor:'pointer',borderRadius:6}}>üè¢ Organization</button><button onClick={()=>{onClose();openTutorial()}} style={{padding:14,background:'transparent',border:'none',color:C.text,textAlign:'left',cursor:'pointer',borderRadius:6}}>üìñ Tutorial</button><button onClick={()=>setV('billing')} style={{padding:14,background:'transparent',border:'none',color:C.text,textAlign:'left',cursor:'pointer',borderRadius:6}}>üí≥ Billing</button><button onClick={()=>setV('legal')} style={{padding:14,background:'transparent',border:'none',color:C.text,textAlign:'left',cursor:'pointer',borderRadius:6}}>üìÑ Legal</button><div style={{height:1,background:C.border,margin:'8px 0'}}/><button onClick={signOut} style={{padding:14,background:'transparent',border:'none',color:C.err,textAlign:'left',cursor:'pointer',borderRadius:6}}>üö™ Sign Out</button></div></div>}{v==='pw'&&<div><button onClick={()=>{setV('main');setMsg('')}} style={{background:'none',border:'none',color:C.textS,cursor:'pointer',marginBottom:16}}>‚Üê Back</button><h4 style={{marginBottom:16}}>Change Password</h4>{msg&&<div style={{padding:12,background:msg==='Updated!'?`${C.ok}20`:`${C.err}20`,borderRadius:6,marginBottom:16,color:msg==='Updated!'?C.ok:C.err}}>{msg}</div>}<Input label="New Password" type="password" value={pw} onChange={e=>setPw(e.target.value)} minLength={6}/><Btn onClick={savePw} disabled={ld||pw.length<6}>{ld?'...':'Update'}</Btn></div>}{v==='org'&&<div><button onClick={()=>{setV('main');setMsg('')}} style={{background:'none',border:'none',color:C.textS,cursor:'pointer',marginBottom:16}}>‚Üê Back</button><h4 style={{marginBottom:16}}>Organization</h4>{msg&&<div style={{padding:12,background:msg==='Saved!'?`${C.ok}20`:`${C.err}20`,borderRadius:6,marginBottom:16,color:msg==='Saved!'?C.ok:C.err}}>{msg}</div>}<Input label="Name" value={oName} onChange={e=>setOName(e.target.value)}/><Input label="Logo URL" value={oLogo} onChange={e=>setOLogo(e.target.value)}/>{oLogo&&<img src={oLogo} style={{maxHeight:50,marginBottom:16,borderRadius:4}} onError={e=>e.target.style.display='none'}/>}<Btn onClick={saveOrg} disabled={ld||!oName.trim()}>{ld?'...':'Save'}</Btn></div>}{v==='billing'&&<div><button onClick={()=>setV('main')} style={{background:'none',border:'none',color:C.textS,cursor:'pointer',marginBottom:16}}>‚Üê Back</button><h4 style={{marginBottom:16}}>Billing</h4><div style={{padding:24,background:C.bg,borderRadius:8,textAlign:'center'}}><div style={{fontSize:12,color:C.textM}}>PLAN</div><div style={{fontSize:24,fontWeight:600,marginBottom:8}}>Free Trial</div><Btn v="accent">Upgrade $25/mo</Btn></div></div>}{v==='legal'&&<div><button onClick={()=>setV('main')} style={{background:'none',border:'none',color:C.textS,cursor:'pointer',marginBottom:16}}>‚Üê Back</button><h4 style={{marginBottom:16}}>Legal</h4><a href="#" onClick={e=>{e.preventDefault();alert('EULA')}} style={{display:'block',padding:16,background:C.bg,borderRadius:8,color:C.text,marginBottom:8}}>üìã EULA</a><a href="#" onClick={e=>{e.preventDefault();alert('Privacy')}} style={{display:'block',padding:16,background:C.bg,borderRadius:8,color:C.text}}>üîí Privacy Policy</a></div>}</Modal>};

const MainApp=()=>{
  const{user,profile,org,signOut,showTutorial,closeTutorial}=useAuth();
  const{mob,tab}=useWin();
  const{projects,loading:pL,create,del,addRes,updateRes,delRes,addVen,updateVen,delVen,addCost,updateCost,delCost}=useProjects(org?.id);
  const{members,invites,invite,cancelInvite,removeMember}=useTeam(org?.id);
  const[aPid,setAPid]=React.useState(null);
  const[view,setView]=React.useState('planner');
  const[periods,setPeriods]=React.useState(12);
  const[showAll,setShowAll]=React.useState(false);
  const[modal,setModal]=React.useState(null);
  const[edit,setEdit]=React.useState(null);
  const[saving,setSaving]=React.useState(false);
  const[mobMenu,setMobMenu]=React.useState(false);
  const[delPid,setDelPid]=React.useState(null);
  const[profileOpen,setProfileOpen]=React.useState(false);
  const emptyRes={type_id:'developer',name:'',rate:150,quantity:1,duration_periods:3,allocation:100,employment_type:'fte',cost_type:'capex',start_period:0};
  const emptyVen={vendor:'',description:'',contract_type:'fixed',amount:0,cost_type:'capex',timing:'lump',duration:12};
  const emptyCost={category:'software',name:'',vendor:'',amount:0,cost_type:'capex',timing:'lump',frequency:'annual',duration:1};
  const[nProj,setNProj]=React.useState({name:'',fy:'FY2025'});
  const[nRes,setNRes]=React.useState(emptyRes);
  const[nVen,setNVen]=React.useState(emptyVen);
  const[nCost,setNCost]=React.useState(emptyCost);
  const[invEmail,setInvEmail]=React.useState('');
  const[invRole,setInvRole]=React.useState('member');
  React.useEffect(()=>{if(projects.length&&!aPid)setAPid(projects[0].id)},[projects]);
  const aP=projects.find(p=>p.id===aPid);
  const getT=p=>{if(!p)return{fte:0,con:0,ven:0,oth:0,tot:0,capex:0,opex:0,fteH:0,conH:0};const res=p.resources||[];const vens=p.vendor_services||[];const oths=p.other_costs||[];const fteR=res.filter(r=>r.employment_type==='fte');const conR=res.filter(r=>r.employment_type==='consultant');const fte=fteR.reduce((s,r)=>s+cCost(r),0);const con=conR.reduce((s,r)=>s+cCost(r),0);const ven=vens.reduce((s,v)=>s+(v.timing==='recurring'?v.amount*v.duration:v.amount),0);const oth=oths.reduce((s,c)=>s+(c.timing==='recurring'?c.amount*c.duration:c.amount),0);const items=[...fteR.map(r=>({ct:r.cost_type,a:cCost(r)})),...conR.map(r=>({ct:r.cost_type,a:cCost(r)})),...vens.map(v=>({ct:v.cost_type,a:v.timing==='recurring'?v.amount*v.duration:v.amount})),...oths.map(c=>({ct:c.cost_type,a:c.timing==='recurring'?c.amount*c.duration:c.amount}))];const capex=items.filter(i=>i.ct==='capex').reduce((s,i)=>s+i.a,0);const opex=items.filter(i=>i.ct==='opex').reduce((s,i)=>s+i.a,0);return{fte,con,ven,oth,tot:fte+con+ven+oth,capex,opex,fteH:fteR.reduce((s,r)=>s+cHrs(r),0),conH:conR.reduce((s,r)=>s+cHrs(r),0)}};
  const T=showAll?projects.reduce((a,p)=>{const t=getT(p);return Object.keys(a).reduce((x,k)=>({...x,[k]:a[k]+t[k]}),{})},{fte:0,con:0,ven:0,oth:0,tot:0,capex:0,opex:0,fteH:0,conH:0}):getT(aP);
  const doCreateProj=async()=>{if(!nProj.name.trim())return;setSaving(true);try{const p=await create({name:nProj.name.trim(),fiscal_year:nProj.fy,color:PCOLS[projects.length%PCOLS.length],start_date:new Date().toISOString().split('T')[0],created_by:user.id});setAPid(p.id);setShowAll(false);setModal(null);setNProj({name:'',fy:'FY2025'})}catch(e){alert(e.message)}setSaving(false)};
  const doDelProj=async()=>{if(!delPid)return;setSaving(true);try{await del(delPid);setDelPid(null);if(aPid===delPid)setAPid(projects.find(p=>p.id!==delPid)?.id||null)}catch(e){alert(e.message)}setSaving(false)};
  const doSaveRes=async()=>{if(!aP||!nRes.name.trim())return;setSaving(true);try{if(edit)await updateRes(aP.id,edit.id,nRes);else await addRes(aP.id,nRes);setModal(null);setEdit(null);setNRes(emptyRes)}catch(e){alert(e.message)}setSaving(false)};
  const doSaveVen=async()=>{if(!aP||!nVen.vendor.trim())return;setSaving(true);try{if(edit)await updateVen(aP.id,edit.id,nVen);else await addVen(aP.id,nVen);setModal(null);setEdit(null);setNVen(emptyVen)}catch(e){alert(e.message)}setSaving(false)};
  const doSaveCost=async()=>{if(!aP||!nCost.name.trim())return;setSaving(true);try{if(edit)await updateCost(aP.id,edit.id,nCost);else await addCost(aP.id,nCost);setModal(null);setEdit(null);setNCost(emptyCost)}catch(e){alert(e.message)}setSaving(false)};
  const doInvite=async()=>{if(!invEmail.trim())return;setSaving(true);try{await invite(invEmail.trim(),invRole);setInvEmail('');alert('Invited!')}catch(e){alert(e.message)}setSaving(false)};
  const openEditRes=r=>{setEdit(r);setNRes({type_id:r.type_id,name:r.name,rate:r.rate,quantity:r.quantity,duration_periods:r.duration_periods,allocation:r.allocation,employment_type:r.employment_type,cost_type:r.cost_type,start_period:r.start_period});setModal('addRes')};
  const openEditVen=v=>{setEdit(v);setNVen({vendor:v.vendor,description:v.description||'',contract_type:v.contract_type,amount:v.amount,cost_type:v.cost_type,timing:v.timing,duration:v.duration||12});setModal('addVen')};
  const openEditCost=c=>{setEdit(c);setNCost({category:c.category,name:c.name,vendor:c.vendor||'',amount:c.amount,cost_type:c.cost_type,timing:c.timing,frequency:c.frequency||'annual',duration:c.duration||1});setModal('addCost')};
  const exportCSV=()=>{const rows=[['Category','Amount'],['FTE',T.fte],['Con',T.con],['Vendors',T.ven],['Other',T.oth],['TOTAL',T.tot],[],['CAPEX',T.capex],['OPEX',T.opex]];const b=new Blob([rows.map(r=>r.join(',')).join('\n')],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='budget.csv';a.click()};
  const pArr=Array.from({length:periods},(_,i)=>i);
  const startD=aP?.start_date?new Date(aP.start_date):new Date();
  const getD=i=>addM(startD,i);
  const allRes=showAll?projects.flatMap(p=>(p.resources||[]).map(r=>({...r,pCol:p.color}))):(aP?.resources||[]);
  if(pL)return<div className="loading"><div className="spinner"/></div>;

  return<div style={{minHeight:'100vh',background:C.bg}}>
    {showTutorial&&<Tutorial onClose={closeTutorial}/>}
    <Settings open={modal==='settings'} onClose={()=>setModal(null)}/>
    <Modal open={!!delPid} onClose={()=>setDelPid(null)} title="Delete Project"><p style={{marginBottom:24,color:C.textS}}>Delete this project?</p><div style={{display:'flex',gap:12}}><Btn v="secondary" onClick={()=>setDelPid(null)} style={{flex:1}}>Cancel</Btn><Btn v="danger" onClick={doDelProj} disabled={saving} style={{flex:1}}>Delete</Btn></div></Modal>
    <Modal open={modal==='report'} onClose={()=>setModal(null)} title="Budget Report"><div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12,marginBottom:24}}>{[{l:'Total',v:T.tot,c:C.text},{l:'CAPEX',v:T.capex,c:C.capex},{l:'OPEX',v:T.opex,c:C.opex},{l:'Hours',v:`${(T.fteH+T.conH).toLocaleString()}h`,c:C.fte}].map((i,k)=><div key={k} style={{background:C.bg,padding:12,borderRadius:6}}><div style={{fontSize:11,color:C.textM}}>{i.l}</div><div style={{fontSize:18,fontWeight:600,color:i.c}}>{typeof i.v==='number'?fmt(i.v):i.v}</div></div>)}</div><Btn onClick={exportCSV} style={{width:'100%'}}>Export CSV</Btn></Modal>
    <Modal open={modal==='team'} onClose={()=>setModal(null)} title="Team" wide><div style={{marginBottom:24}}><h4 style={{fontSize:14,color:C.textM,marginBottom:12}}>INVITE</h4><p style={{fontSize:13,color:C.textS,marginBottom:12}}>Invite colleagues to collaborate.</p><div style={{display:'flex',gap:12,flexWrap:'wrap'}}><input type="email" value={invEmail} onChange={e=>setInvEmail(e.target.value)} placeholder="email" style={{flex:1,minWidth:200,padding:12,background:C.bg,border:`1px solid ${C.border}`,borderRadius:6,color:C.text}}/><select value={invRole} onChange={e=>setInvRole(e.target.value)} style={{padding:12,background:C.bg,border:`1px solid ${C.border}`,borderRadius:6,color:C.text}}><option value="member">Member</option><option value="admin">Admin</option><option value="viewer">Viewer</option></select><Btn onClick={doInvite} disabled={saving||!invEmail.trim()}>Invite</Btn></div></div>{invites.length>0&&<div style={{marginBottom:24}}><h4 style={{fontSize:14,color:C.textM,marginBottom:12}}>PENDING ({invites.length})</h4>{invites.map(inv=><div key={inv.id} style={{display:'flex',justifyContent:'space-between',padding:'12px 0',borderBottom:`1px solid ${C.border}`}}><span>{inv.email}</span><button onClick={()=>cancelInvite(inv.id)} style={{background:'none',border:'none',color:C.err,cursor:'pointer'}}>Cancel</button></div>)}</div>}<div><h4 style={{fontSize:14,color:C.textM,marginBottom:12}}>MEMBERS ({members.length})</h4>{members.map(m=><div key={m.user_id} style={{display:'flex',justifyContent:'space-between',padding:'12px 0',borderBottom:`1px solid ${C.border}`}}><span>{m.profiles?.full_name||m.profiles?.email}</span><span style={{fontSize:12,color:m.role==='owner'?C.ok:C.textS}}>{m.role}</span></div>)}</div></Modal>
    <Modal open={modal==='newProj'} onClose={()=>setModal(null)} title="New Project"><Input label="Name" value={nProj.name} onChange={e=>setNProj({...nProj,name:e.target.value})}/><Select label="Fiscal Year" value={nProj.fy} onChange={e=>setNProj({...nProj,fy:e.target.value})}>{FYS.map(f=><option key={f}>{f}</option>)}</Select><Btn onClick={doCreateProj} disabled={saving||!nProj.name.trim()} style={{width:'100%'}}>Create</Btn></Modal>
    <Modal open={modal==='addRes'} onClose={()=>{setModal(null);setEdit(null);setNRes(emptyRes)}} title={edit?'Edit Resource':'Add Resource'}><Select label="Type" value={nRes.type_id} onChange={e=>{const t=RTS.find(r=>r.id===e.target.value);setNRes({...nRes,type_id:e.target.value,rate:edit?nRes.rate:(t?.rate||150)})}}>{RTS.map(t=><option key={t.id} value={t.id}>{t.name}</option>)}</Select><Input label="Name" value={nRes.name} onChange={e=>setNRes({...nRes,name:e.target.value})}/><div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}><Input label="Rate/hr" type="number" value={nRes.rate} onChange={e=>setNRes({...nRes,rate:+e.target.value})}/><Input label="Qty" type="number" value={nRes.quantity} onChange={e=>setNRes({...nRes,quantity:+e.target.value})}/></div><div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}><Input label="Start" type="number" value={nRes.start_period} onChange={e=>setNRes({...nRes,start_period:+e.target.value})}/><Input label="Duration" type="number" value={nRes.duration_periods} onChange={e=>setNRes({...nRes,duration_periods:+e.target.value})}/></div><div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}><Select label="Allocation" value={nRes.allocation} onChange={e=>setNRes({...nRes,allocation:+e.target.value})}><option value={100}>100%</option><option value={75}>75%</option><option value={50}>50%</option><option value={25}>25%</option></Select><Select label="Type" value={nRes.employment_type} onChange={e=>setNRes({...nRes,employment_type:e.target.value})}><option value="fte">FTE</option><option value="consultant">Consultant</option></Select></div><Select label="Cost" value={nRes.cost_type} onChange={e=>setNRes({...nRes,cost_type:e.target.value})}><option value="capex">CAPEX</option><option value="opex">OPEX</option></Select><div style={{background:C.bg,padding:12,borderRadius:6,marginBottom:16,textAlign:'center'}}><span style={{color:C.textM}}>Est: </span><span style={{fontSize:18,fontWeight:600}}>{fmt(nRes.rate*nRes.duration_periods*HPM*nRes.quantity*(nRes.allocation/100))}</span></div><Btn onClick={doSaveRes} disabled={saving||!nRes.name.trim()} style={{width:'100%'}}>{edit?'Save':'Add'}</Btn></Modal>
    <Modal open={modal==='addVen'} onClose={()=>{setModal(null);setEdit(null);setNVen(emptyVen)}} title={edit?'Edit Vendor':'Add Vendor'}><Input label="Vendor" value={nVen.vendor} onChange={e=>setNVen({...nVen,vendor:e.target.value})}/><Input label="Description" value={nVen.description} onChange={e=>setNVen({...nVen,description:e.target.value})}/><div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}><Select label="Contract" value={nVen.contract_type} onChange={e=>setNVen({...nVen,contract_type:e.target.value})}><option value="fixed">Fixed</option><option value="tm">T&M</option></Select><Select label="Cost" value={nVen.cost_type} onChange={e=>setNVen({...nVen,cost_type:e.target.value})}><option value="capex">CAPEX</option><option value="opex">OPEX</option></Select></div><Select label="Timing" value={nVen.timing} onChange={e=>setNVen({...nVen,timing:e.target.value})}><option value="lump">Lump</option><option value="recurring">Recurring</option></Select>{nVen.timing==='recurring'?<div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}><Input label="$/mo" type="number" value={nVen.amount} onChange={e=>setNVen({...nVen,amount:+e.target.value})}/><Input label="Months" type="number" value={nVen.duration} onChange={e=>setNVen({...nVen,duration:+e.target.value})}/></div>:<Input label="Amount" type="number" value={nVen.amount} onChange={e=>setNVen({...nVen,amount:+e.target.value})}/>}<div style={{background:C.bg,padding:12,borderRadius:6,marginBottom:16,textAlign:'center'}}><span style={{color:C.textM}}>Total: </span><span style={{fontSize:18,fontWeight:600}}>{fmt(nVen.timing==='recurring'?nVen.amount*nVen.duration:nVen.amount)}</span></div><Btn onClick={doSaveVen} disabled={saving||!nVen.vendor.trim()} style={{width:'100%'}}>{edit?'Save':'Add'}</Btn></Modal>
    <Modal open={modal==='addCost'} onClose={()=>{setModal(null);setEdit(null);setNCost(emptyCost)}} title={edit?'Edit Cost':'Add Cost'}><Select label="Category" value={nCost.category} onChange={e=>{const c=CCS.find(x=>x.id===e.target.value);setNCost({...nCost,category:e.target.value,cost_type:c?.ct||'opex',timing:c?.tm||'lump'})}}>{CCS.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</Select><Input label="Name" value={nCost.name} onChange={e=>setNCost({...nCost,name:e.target.value})}/><Input label="Vendor" value={nCost.vendor} onChange={e=>setNCost({...nCost,vendor:e.target.value})}/><div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}><Select label="Cost" value={nCost.cost_type} onChange={e=>setNCost({...nCost,cost_type:e.target.value})}><option value="capex">CAPEX</option><option value="opex">OPEX</option></Select><Select label="Timing" value={nCost.timing} onChange={e=>setNCost({...nCost,timing:e.target.value})}><option value="lump">Lump</option><option value="recurring">Recurring</option></Select></div>{nCost.timing==='recurring'?<div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:12}}><Input label="Amt" type="number" value={nCost.amount} onChange={e=>setNCost({...nCost,amount:+e.target.value})}/><Select label="Freq" value={nCost.frequency} onChange={e=>setNCost({...nCost,frequency:e.target.value})}><option value="monthly">Mo</option><option value="quarterly">Qtr</option><option value="annual">Yr</option></Select><Input label="#" type="number" value={nCost.duration} onChange={e=>setNCost({...nCost,duration:+e.target.value})}/></div>:<Input label="Amount" type="number" value={nCost.amount} onChange={e=>setNCost({...nCost,amount:+e.target.value})}/>}<div style={{background:C.bg,padding:12,borderRadius:6,marginBottom:16,textAlign:'center'}}><span style={{color:C.textM}}>Total: </span><span style={{fontSize:18,fontWeight:600}}>{fmt(nCost.timing==='recurring'?nCost.amount*nCost.duration:nCost.amount)}</span></div><Btn onClick={doSaveCost} disabled={saving||!nCost.name.trim()} style={{width:'100%'}}>{edit?'Save':'Add'}</Btn></Modal>

    <nav style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:mob?'12px 16px':'16px 32px',borderBottom:`1px solid ${C.border}`,background:C.card}}>
      <div style={{display:'flex',alignItems:'center',gap:16}}>
        <span style={{fontSize:mob?16:18,fontWeight:600}}>Portfolio Planner</span>
        {org&&<div style={{display:'flex',alignItems:'center',gap:10,padding:'8px 14px',background:C.bg,border:`1px solid ${C.border}`,borderRadius:8}}>
          {org.logo_url&&<img src={org.logo_url} style={{height:28,borderRadius:4}} onError={e=>e.target.style.display='none'}/>}
          <span style={{fontSize:14,fontWeight:500,color:C.text}}>{org.name}</span>
        </div>}
      </div>
      {mob?<button onClick={()=>setMobMenu(!mobMenu)} style={{background:'transparent',border:'none',color:C.text,fontSize:24,cursor:'pointer'}}>‚ò∞</button>:
      <div style={{display:'flex',alignItems:'center',gap:8}}>
        <Tooltip text="Invite team members to collaborate on projects."><Btn v="secondary" onClick={()=>setModal('team')} style={{padding:'8px 16px'}}>Team <span style={{opacity:.5}}>?</span></Btn></Tooltip>
        <Tooltip text="View budget summary and export to CSV."><Btn v="secondary" onClick={()=>setModal('report')} style={{padding:'8px 16px'}}>Report <span style={{opacity:.5}}>?</span></Btn></Tooltip>
        <div className="dropdown">
          <Btn v="secondary" onClick={()=>setProfileOpen(!profileOpen)} style={{padding:'8px 12px',display:'flex',alignItems:'center',gap:8}}>
            <span style={{width:28,height:28,borderRadius:14,background:C.accent,display:'flex',alignItems:'center',justifyContent:'center',fontSize:12,fontWeight:600}}>{(profile?.full_name||'U')[0]}</span>
            <span style={{fontSize:12}}>‚ñº</span>
          </Btn>
          {profileOpen&&<div className="dropdown-menu" onClick={()=>setProfileOpen(false)}>
            <div style={{padding:'12px 16px',borderBottom:`1px solid ${C.border}`}}><div style={{fontWeight:500}}>{profile?.full_name}</div><div style={{fontSize:12,color:C.textM}}>{profile?.email}</div></div>
            <div className="dropdown-item" onClick={()=>setModal('settings')}>‚öôÔ∏è Settings</div>
            <div className="dropdown-item" onClick={signOut}>üö™ Sign Out</div>
          </div>}
        </div>
      </div>}
    </nav>
    {mob&&mobMenu&&<div style={{padding:16,borderBottom:`1px solid ${C.border}`,background:C.card,display:'flex',flexDirection:'column',gap:8}}><Btn v="secondary" onClick={()=>{setModal('team');setMobMenu(false)}} style={{width:'100%'}}>Team</Btn><Btn v="secondary" onClick={()=>{setModal('report');setMobMenu(false)}} style={{width:'100%'}}>Report</Btn><Btn v="secondary" onClick={()=>{setModal('settings');setMobMenu(false)}} style={{width:'100%'}}>Settings</Btn><Btn v="secondary" onClick={signOut} style={{width:'100%'}}>Sign Out</Btn></div>}

    <div style={{padding:mob?16:'24px 32px'}}>
      <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:16,flexWrap:'wrap'}}>
        <button onClick={()=>setShowAll(!showAll)} style={{padding:'10px 16px',border:showAll?`2px solid ${C.accent}`:`1px solid ${C.border}`,borderRadius:8,background:showAll?`${C.accent}15`:'transparent',color:showAll?C.text:C.textS,cursor:'pointer',fontWeight:600}}>üìä Portfolio</button>
        {projects.map(p=><div key={p.id} style={{position:'relative'}}><button onClick={()=>{setAPid(p.id);setShowAll(false)}} style={{padding:'10px 16px',paddingRight:!showAll&&aPid===p.id?36:16,border:!showAll&&aPid===p.id?`2px solid ${p.color}`:`1px solid ${C.border}`,borderRadius:8,background:!showAll&&aPid===p.id?`${p.color}15`:'transparent',color:!showAll&&aPid===p.id?C.text:C.textS,cursor:'pointer',fontWeight:500,display:'flex',alignItems:'center',gap:8}}><div style={{width:10,height:10,borderRadius:3,background:p.color}}/>{p.name}</button>{!showAll&&aPid===p.id&&<button onClick={e=>{e.stopPropagation();setDelPid(p.id)}} style={{position:'absolute',right:8,top:'50%',transform:'translateY(-50%)',background:'transparent',border:'none',color:C.textM,cursor:'pointer',fontSize:16}}>√ó</button>}</div>)}
        <button onClick={()=>setModal('newProj')} style={{padding:'10px 20px',border:`2px dashed ${C.borderL}`,borderRadius:8,background:'transparent',color:C.textS,cursor:'pointer',fontWeight:600}}>‚ûï New Project</button>
      </div>

      {projects.length===0&&<div style={{textAlign:'center',padding:'80px 20px',background:C.card,borderRadius:12,border:`1px solid ${C.border}`}}><div style={{fontSize:48,marginBottom:16}}>üìÅ</div><h2 style={{marginBottom:8}}>Create Your First Project</h2><p style={{color:C.textS,marginBottom:24}}>Start planning resources and tracking costs.</p><Btn v="accent" onClick={()=>setModal('newProj')} style={{padding:'14px 32px'}}>‚ûï Create Project</Btn></div>}

      {projects.length>0&&<>
        {!showAll&&aP&&<div style={{display:'flex',gap:8,marginBottom:16}}><button onClick={()=>setView('planner')} style={{padding:'10px 20px',border:view==='planner'?`2px solid ${C.text}`:`1px solid ${C.border}`,borderRadius:8,background:view==='planner'?'rgba(255,255,255,.08)':'transparent',color:view==='planner'?C.text:C.textS,cursor:'pointer',fontWeight:500}}>üìÖ Planner</button><button onClick={()=>setView('budget')} style={{padding:'10px 20px',border:view==='budget'?`2px solid ${C.text}`:`1px solid ${C.border}`,borderRadius:8,background:view==='budget'?'rgba(255,255,255,.08)':'transparent',color:view==='budget'?C.text:C.textS,cursor:'pointer',fontWeight:500}}>üí∞ Budget</button></div>}

        <div style={{display:'grid',gridTemplateColumns:mob?'repeat(2,1fr)':tab?'repeat(3,1fr)':'repeat(5,1fr)',gap:12,marginBottom:24}}>{[{l:'Total Budget',v:fmt(T.tot),c:C.text},{l:'CAPEX',v:fmt(T.capex),c:C.capex},{l:'OPEX',v:fmt(T.opex),c:C.opex},{l:'FTE Hours',v:`${T.fteH.toLocaleString()}h`,c:C.fte},{l:'Consultant Hrs',v:`${T.conH.toLocaleString()}h`,c:C.con}].map((d,i)=><div key={i} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:10,padding:16}}><div style={{fontSize:11,color:C.textS,marginBottom:6,textTransform:'uppercase'}}>{d.l}</div><div style={{fontSize:mob?18:24,fontWeight:700,color:d.c}}>{d.v}</div></div>)}</div>

        {(showAll||view==='planner')&&<>
          <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:16,padding:14,background:C.card,borderRadius:10,border:`1px solid ${C.border}`,flexWrap:'wrap'}}><div style={{display:'flex',alignItems:'center',gap:8}}><button onClick={()=>setPeriods(p=>Math.max(4,p-2))} style={{width:32,height:32,border:`1px solid ${C.border}`,borderRadius:6,background:C.bg,color:C.text,cursor:'pointer'}}>‚àí</button><span style={{minWidth:30,textAlign:'center',fontWeight:500}}>{periods}</span><button onClick={()=>setPeriods(p=>Math.min(52,p+2))} style={{width:32,height:32,border:`1px solid ${C.border}`,borderRadius:6,background:C.bg,color:C.text,cursor:'pointer'}}>+</button><span style={{color:C.textS,marginLeft:4}}>months</span></div>{!showAll&&<span style={{color:C.textS}}>üí° Drag to move ¬∑ Drag edges to resize ¬∑ Double-click to edit</span>}</div>
          {!showAll&&aP&&<button onClick={()=>{setEdit(null);setNRes(emptyRes);setModal('addRes')}} style={{marginBottom:16,padding:'12px 20px',background:C.accent,border:'none',borderRadius:8,color:'#fff',fontWeight:600,cursor:'pointer'}}>‚ûï Add Resource</button>}
          <div style={{background:C.card,borderRadius:10,border:`1px solid ${C.border}`,overflow:'hidden',overflowX:'auto'}}><div style={{minWidth:mob?800:'auto'}}><div style={{display:'grid',gridTemplateColumns:`repeat(${periods},1fr)`,borderBottom:`1px solid ${C.border}`}}>{pArr.map((p,i)=><div key={p} style={{padding:'10px 4px',textAlign:'center',fontSize:11,color:C.textS,fontWeight:500,borderRight:i<pArr.length-1?`1px solid ${C.border}`:'none'}}>{fmtM(getD(p))}</div>)}</div><div style={{position:'relative',minHeight:Math.max(180,allRes.length*54+30),padding:'10px 0'}}>{pArr.map((_,i)=><div key={i} style={{position:'absolute',left:`${(i/periods)*100}%`,top:0,bottom:0,width:1,background:C.border,opacity:.3}}/>)}{allRes.map((r,idx)=>{const t=RTS.find(x=>x.id===r.type_id);const col=showAll?r.pCol:t?.color||'#888';return<RBar key={r.id} r={r} idx={idx} periods={periods} color={col} showAll={showAll} onUpd={(rid,u)=>updateRes(aP.id,rid,u)} onDel={rid=>delRes(aP.id,rid)} onEdit={openEditRes}/>})}{allRes.length===0&&<div style={{display:'flex',alignItems:'center',justifyContent:'center',height:180,color:C.textM}}>Add resources to see them here</div>}</div></div></div>
        </>}

        {!showAll&&view==='budget'&&aP&&<div style={{display:'flex',flexDirection:'column',gap:16}}>
          <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:10}}><div style={{padding:18,borderBottom:`1px solid ${C.border}`,display:'flex',justifyContent:'space-between'}}><span style={{fontWeight:600}}>FTE Labor</span><span style={{fontWeight:700,color:C.fte}}>{fmt(T.fte)}</span></div><div style={{padding:16}}>{(aP.resources||[]).filter(r=>r.employment_type==='fte').length===0?<p style={{color:C.textM}}>None</p>:(aP.resources||[]).filter(r=>r.employment_type==='fte').map(r=><div key={r.id} style={{display:'flex',justifyContent:'space-between',padding:'10px 0',borderBottom:`1px solid ${C.border}`,cursor:'pointer'}} onClick={()=>openEditRes(r)}><span>{r.name}</span><span style={{color:C.textS}}>{fmt(cCost(r))}</span></div>)}</div></div>
          <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:10}}><div style={{padding:18,borderBottom:`1px solid ${C.border}`,display:'flex',justifyContent:'space-between'}}><span style={{fontWeight:600}}>Consultants</span><span style={{fontWeight:700,color:C.con}}>{fmt(T.con)}</span></div><div style={{padding:16}}>{(aP.resources||[]).filter(r=>r.employment_type==='consultant').length===0?<p style={{color:C.textM}}>None</p>:(aP.resources||[]).filter(r=>r.employment_type==='consultant').map(r=><div key={r.id} style={{display:'flex',justifyContent:'space-between',padding:'10px 0',borderBottom:`1px solid ${C.border}`,cursor:'pointer'}} onClick={()=>openEditRes(r)}><span>{r.name}</span><span style={{color:C.textS}}>{fmt(cCost(r))}</span></div>)}</div></div>
          <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:10}}><div style={{padding:18,borderBottom:`1px solid ${C.border}`,display:'flex',justifyContent:'space-between',alignItems:'center'}}><span style={{fontWeight:600}}>Vendors</span><div style={{display:'flex',gap:12,alignItems:'center'}}><span style={{fontWeight:700,color:'#8b5cf6'}}>{fmt(T.ven)}</span><button onClick={()=>{setEdit(null);setNVen(emptyVen);setModal('addVen')}} style={{padding:'8px 14px',background:C.accent,border:'none',borderRadius:6,color:'#fff',fontWeight:600,cursor:'pointer'}}>+ Add</button></div></div><div style={{padding:16}}>{(aP.vendor_services||[]).length===0?<p style={{color:C.textM}}>None</p>:(aP.vendor_services||[]).map(v=><div key={v.id} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'12px 0',borderBottom:`1px solid ${C.border}`,cursor:'pointer'}} onClick={()=>openEditVen(v)}><div><div style={{fontWeight:500}}>{v.vendor}</div><div style={{fontSize:13,color:C.textM}}>{v.description}</div></div><div style={{display:'flex',gap:12,alignItems:'center'}}><span style={{fontWeight:600}}>{fmt(v.timing==='recurring'?v.amount*v.duration:v.amount)}</span><button onClick={e=>{e.stopPropagation();delVen(aP.id,v.id)}} style={{background:'transparent',border:'none',color:C.textM,cursor:'pointer',fontSize:18}}>√ó</button></div></div>)}</div></div>
          <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:10}}><div style={{padding:18,borderBottom:`1px solid ${C.border}`,display:'flex',justifyContent:'space-between',alignItems:'center'}}><span style={{fontWeight:600}}>Other Costs</span><div style={{display:'flex',gap:12,alignItems:'center'}}><span style={{fontWeight:700}}>{fmt(T.oth)}</span><button onClick={()=>{setEdit(null);setNCost(emptyCost);setModal('addCost')}} style={{padding:'8px 14px',background:C.accent,border:'none',borderRadius:6,color:'#fff',fontWeight:600,cursor:'pointer'}}>+ Add</button></div></div><div style={{padding:16}}>{(aP.other_costs||[]).length===0?<p style={{color:C.textM}}>None</p>:(aP.other_costs||[]).map(c=>{const cat=CCS.find(x=>x.id===c.category);return<div key={c.id} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'12px 0',borderBottom:`1px solid ${C.border}`,cursor:'pointer'}} onClick={()=>openEditCost(c)}><div><div style={{fontWeight:500}}>{c.name}</div><div style={{fontSize:13,color:C.textM}}>{cat?.name}</div></div><div style={{display:'flex',gap:12,alignItems:'center'}}><span style={{fontWeight:600}}>{fmt(c.timing==='recurring'?c.amount*c.duration:c.amount)}</span><button onClick={e=>{e.stopPropagation();delCost(aP.id,c.id)}} style={{background:'transparent',border:'none',color:C.textM,cursor:'pointer',fontSize:18}}>√ó</button></div></div>})}</div></div>
        </div>}
      </>}
    </div>
  </div>;
};

const App=()=>{const{user,org,loading}=useAuth();const[page,setPage]=React.useState('landing');React.useEffect(()=>{if(window.location.hash.includes('type=recovery'))setPage('auth')},[]);if(loading)return<div className="loading"><div className="spinner"/></div>;if(user&&!org)return<Onboarding/>;if(user&&org)return<MainApp/>;if(page==='auth')return<AuthPage onBack={()=>setPage('landing')}/>;return<Landing onStart={()=>setPage('auth')}/>};
const Root=()=><AuthProvider><App/></AuthProvider>;
ReactDOM.createRoot(document.getElementById('root')).render(<Root/>);
</script>
</body>
</html>
