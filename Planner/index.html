<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Portfolio Planner | Chesapeake Systems</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“Š</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',-apple-system,sans-serif;background:#0c1222;color:#fff;min-height:100vh}
    .loading{display:flex;align-items:center;justify-content:center;min-height:100vh;flex-direction:column;gap:16px}
    .spinner{width:40px;height:40px;border:3px solid #1e3a5f;border-top-color:#3b82f6;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    ::-webkit-scrollbar{width:8px;height:8px}
    ::-webkit-scrollbar-track{background:#0c1222}
    ::-webkit-scrollbar-thumb{background:#1e3a5f;border-radius:4px}
    input:focus,select:focus,textarea:focus,button:focus{outline:2px solid #3b82f6;outline-offset:2px}
    textarea{font-family:inherit;resize:vertical}
    .rbar{position:absolute;height:44px;border-radius:6px;display:flex;align-items:center;padding:0 12px;justify-content:space-between;cursor:grab;user-select:none}
    .rbar:hover{box-shadow:0 0 0 2px rgba(255,255,255,0.3)}
    .rbar.drag{cursor:grabbing;box-shadow:0 0 0 2px #fff;z-index:100}
    .rh{position:absolute;top:0;bottom:0;width:12px;cursor:ew-resize}
    .rh::after{content:'';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:3px;height:20px;background:rgba(255,255,255,0.3);border-radius:2px}
    .rbar:hover .rh::after{background:rgba(255,255,255,0.6)}
    .rh-l{left:0}.rh-r{right:0}
    .milestone{position:absolute;top:0;bottom:0;width:4px;background:#f59e0b;cursor:ew-resize;z-index:50;border-radius:2px}
    .milestone::before{content:attr(data-name);position:absolute;top:-26px;left:50%;transform:translateX(-50%);background:#f59e0b;color:#000;padding:3px 10px;border-radius:4px;font-size:11px;font-weight:600;white-space:nowrap}
    .milestone:hover{background:#fbbf24;box-shadow:0 0 12px rgba(251,191,36,0.6)}
    .time-toggle{display:flex;background:#1e3a5f;border-radius:6px;overflow:hidden}
    .time-toggle button{padding:6px 14px;border:none;background:transparent;color:#94a3b8;font-size:12px;font-weight:500;cursor:pointer}
    .time-toggle button.active{background:#3b82f6;color:#fff}
    .dropdown{position:relative}
    .dropdown-menu{position:absolute;top:100%;right:0;margin-top:8px;background:#131c2e;border:1px solid #1e3a5f;border-radius:8px;min-width:220px;z-index:1000;overflow:hidden}
    .dropdown-item{padding:12px 16px;cursor:pointer;display:flex;align-items:center;gap:10px;font-size:14px;color:#94a3b8;border-bottom:1px solid #1e3a5f}
    .dropdown-item:last-child{border-bottom:none}
    .dropdown-item:hover{background:#1e3a5f;color:#fff}
    .cost-cat{background:#131c2e;border:1px solid #1e3a5f;border-radius:10px;margin-bottom:12px}
    .cost-cat-header{padding:14px 18px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #1e3a5f}
    .cost-item{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;border-bottom:1px solid #0c1222;cursor:pointer}
    .cost-item:hover{background:#1e3a5f20}
    .cost-item:last-child{border-bottom:none}
    .priority-badge{padding:4px 10px;border-radius:4px;font-size:11px;font-weight:600}
  </style>
</head>
<body>
<div id="root"><div class="loading"><div class="spinner"></div><span style="color:#666">Loading...</span></div></div>
<script type="text/babel">
const SUPABASE_URL='https://lzmstiaexrelqviksdjt.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx6bXN0aWFleHJlbHF2aWtzZGp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1OTA3MDAsImV4cCI6MjA4NDE2NjcwMH0.Ys-BX1yVk-31xQg5hUsyBxvFTHPyaocbOsuUvXXxf-k';
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
const C={bg:'#0c1222',card:'#131c2e',border:'#1e3a5f',borderL:'#2d4a6f',text:'#fff',textS:'#94a3b8',textM:'#64748b',capex:'#3b82f6',opex:'#ec4899',fte:'#14b8a6',con:'#f97316',err:'#ef4444',ok:'#14b8a6',accent:'#3b82f6',accent2:'#14b8a6',milestone:'#f59e0b'};
const RCOLS=['#3B82F6','#EC4899','#10B981','#F59E0B','#8B5CF6','#EF4444','#06b6d4','#84cc16','#a855f7','#14b8a6'];
const FYS=['FY2024','FY2025','FY2026','FY2027','FY2028'];
const PCOLS=['#3B82F6','#10B981','#F59E0B','#EF4444','#8B5CF6','#EC4899','#06b6d4','#84cc16'];
const PRIORITIES=[{v:1,l:'Critical',c:'#ef4444'},{v:2,l:'High',c:'#f97316'},{v:3,l:'Medium',c:'#eab308'},{v:4,l:'Low',c:'#22c55e'},{v:5,l:'Nice-to-have',c:'#64748b'}];
const HPM=160,HPW=40;
const fmt=n=>new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:0,maximumFractionDigits:0}).format(n);
const addM=(d,m)=>{const r=new Date(d);r.setMonth(r.getMonth()+m);return r};
const addW=(d,w)=>{const r=new Date(d);r.setDate(r.getDate()+w*7);return r};
const fmtM=d=>d.toLocaleDateString('en-US',{month:'short',year:'numeric'});
const fmtW=d=>d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
const cCost=(r,unit='months')=>(r.track_cost===false?0:(r.rate||0)*r.duration_periods*(unit==='weeks'?HPW:HPM)*r.quantity*(r.allocation/100));
const cHrs=(r,unit='months')=>(r.track_hours===false?0:r.duration_periods*(unit==='weeks'?HPW:HPM)*r.quantity*(r.allocation/100));
const useWin=()=>{const[w,sW]=React.useState(window.innerWidth);React.useEffect(()=>{const h=()=>sW(window.innerWidth);window.addEventListener('resize',h);return()=>window.removeEventListener('resize',h)},[]);return{w,mob:w<768,tab:w>=768&&w<1024}};

const Modal=({open,onClose,title,children,wide})=>{if(!open)return null;return<div style={{position:'fixed',inset:0,background:'rgba(0,0,0,.7)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:1000,padding:16}} onClick={onClose}><div style={{background:C.card,border:'1px solid '+C.border,borderRadius:12,padding:28,width:'100%',maxWidth:wide?600:420,maxHeight:'90vh',overflow:'auto'}} onClick={e=>e.stopPropagation()}><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}><h3 style={{fontSize:18,fontWeight:600}}>{title}</h3><button onClick={onClose} style={{background:'transparent',border:'none',color:C.textM,fontSize:24,cursor:'pointer',lineHeight:1}}>Ã—</button></div>{children}</div></div>};
const Btn=({children,v='primary',disabled,...p})=><button disabled={disabled} {...p} style={{padding:'12px 24px',border:v==='secondary'?'1px solid '+C.border:v==='danger'?'1px solid '+C.err:'none',borderRadius:8,background:v==='primary'?C.accent:v==='accent'?'linear-gradient(135deg,#3b82f6,#14b8a6)':v==='danger'?'transparent':'transparent',color:v==='danger'?C.err:C.text,fontWeight:600,cursor:disabled?'not-allowed':'pointer',opacity:disabled?.5:1,fontSize:14,...p.style}}>{children}</button>;
const Input=({label,...p})=><div style={{marginBottom:16}}>{label&&<label style={{display:'block',fontSize:12,color:C.textS,marginBottom:6,textTransform:'uppercase'}}>{label}</label>}<input {...p} style={{width:'100%',padding:12,background:C.bg,border:'1px solid '+C.border,borderRadius:6,color:C.text,fontSize:14,...p.style}}/></div>;
const Select=({label,children,...p})=><div style={{marginBottom:16}}>{label&&<label style={{display:'block',fontSize:12,color:C.textS,marginBottom:6,textTransform:'uppercase'}}>{label}</label>}<select {...p} style={{width:'100%',padding:12,background:C.bg,border:'1px solid '+C.border,borderRadius:6,color:C.text,fontSize:14,...p.style}}>{children}</select></div>;
const Textarea=({label,...p})=><div style={{marginBottom:16}}>{label&&<label style={{display:'block',fontSize:12,color:C.textS,marginBottom:6,textTransform:'uppercase'}}>{label}</label>}<textarea {...p} style={{width:'100%',padding:12,background:C.bg,border:'1px solid '+C.border,borderRadius:6,color:C.text,fontSize:14,minHeight:80,...p.style}}/></div>;
const Checkbox=({label,checked,onChange})=><label style={{display:'flex',alignItems:'center',gap:10,marginBottom:12,cursor:'pointer'}}><input type="checkbox" checked={checked} onChange={e=>onChange(e.target.checked)} style={{width:18,height:18,accentColor:C.accent}}/><span style={{fontSize:14,color:C.textS}}>{label}</span></label>;
const Logo=({size=20,onClick})=><button onClick={onClick} style={{background:'none',border:'none',cursor:onClick?'pointer':'default',display:'flex',alignItems:'center',gap:8}}><span style={{fontSize:size}}>ðŸ“Š</span><span style={{fontSize:size,fontWeight:600,color:C.text}}>Portfolio Planner</span></button>;
const validatePw=pw=>{const e=[];if(pw.length<8)e.push('8+ chars');if(!/[A-Z]/.test(pw))e.push('uppercase');if(!/[0-9]/.test(pw))e.push('number');if(!/[!@#$%^&*(),.?":{}|<>]/.test(pw))e.push('special');return e};

const Tutorial=({onClose})=>{const SLIDES=[{icon:'ðŸ‘‹',title:'Welcome to Portfolio Planner',desc:'Plan resources, track costs, and manage project priorities.'},{icon:'ðŸ“…',title:'Weeks or Months',desc:'Toggle between weekly or monthly timeline views.'},{icon:'ðŸ‘¥',title:'Resource Types',desc:'Create custom resource types with colors and rates.'},{icon:'ðŸŽ¯',title:'Scope & Priority',desc:'Add project scope description and set priority for portfolio ranking.'},{icon:'ðŸ’°',title:'Flexible Cost Categories',desc:'Add cost categories as needed. Each can have named subcategories with CAPEX/OPEX.'},{icon:'ðŸ“Š',title:'Excel Export',desc:'Export full reports with summary, costs, and monthly breakdowns for PMO.'}];const[i,setI]=React.useState(0);return<div style={{position:'fixed',inset:0,background:'rgba(0,0,0,.85)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:2000,padding:20}}><div style={{background:C.card,border:'1px solid '+C.border,borderRadius:16,padding:40,maxWidth:480,textAlign:'center'}}><div style={{fontSize:64,marginBottom:20}}>{SLIDES[i].icon}</div><h2 style={{fontSize:24,marginBottom:12}}>{SLIDES[i].title}</h2><p style={{color:C.textS,marginBottom:32,lineHeight:1.6}}>{SLIDES[i].desc}</p><div style={{display:'flex',gap:6,justifyContent:'center',marginBottom:24}}>{SLIDES.map((_,idx)=><div key={idx} style={{width:8,height:8,borderRadius:4,background:idx===i?C.accent:C.border}}/>)}</div><div style={{display:'flex',gap:12,justifyContent:'center'}}>{i>0&&<Btn v="secondary" onClick={()=>setI(i-1)}>Back</Btn>}<Btn v="secondary" onClick={onClose}>Skip</Btn>{i<SLIDES.length-1?<Btn onClick={()=>setI(i+1)}>Next</Btn>:<Btn v="accent" onClick={onClose}>Get Started</Btn>}</div></div></div>};

const RBar=({r,idx,periods,color,showAll,resourceTypes,timeUnit,onUpd,onDel,onEdit})=>{const[drag,setDrag]=React.useState(null);const t=resourceTypes?.find(x=>x.id===r.type_id);const name=r.name||t?.name||'Resource';const left=(r.start_period/periods)*100;const width=(r.duration_periods/periods)*100;const onMD=(e,type)=>{e.stopPropagation();if(showAll)return;setDrag({type,startX:e.clientX,origStart:r.start_period,origDur:r.duration_periods})};React.useEffect(()=>{if(!drag)return;const onMM=e=>{const dx=e.clientX-drag.startX;const dp=Math.round(dx/(window.innerWidth*.7/periods));if(drag.type==='move'){const ns=Math.max(0,Math.min(periods-drag.origDur,drag.origStart+dp));if(ns!==r.start_period)onUpd(r.id,{start_period:ns})}else if(drag.type==='left'){const ns=Math.max(0,drag.origStart+dp);const nd=drag.origDur-(ns-drag.origStart);if(nd>=1&&ns!==r.start_period)onUpd(r.id,{start_period:ns,duration_periods:nd})}else{const nd=Math.max(1,Math.min(periods-r.start_period,drag.origDur+dp));if(nd!==r.duration_periods)onUpd(r.id,{duration_periods:nd})}};const onMU=()=>setDrag(null);window.addEventListener('mousemove',onMM);window.addEventListener('mouseup',onMU);return()=>{window.removeEventListener('mousemove',onMM);window.removeEventListener('mouseup',onMU)}},[drag]);const cost=cCost(r,timeUnit);const showCost=r.track_cost!==false&&cost>0;return<div className={'rbar'+(drag?' drag':'')} style={{left:left+'%',width:width+'%',top:idx*54+30,background:color}} onMouseDown={e=>onMD(e,'move')} onDoubleClick={()=>!showAll&&onEdit(r)}><div className="rh rh-l" onMouseDown={e=>onMD(e,'left')}/><div style={{display:'flex',alignItems:'center',gap:6,overflow:'hidden',flex:1}}><span style={{fontWeight:600,fontSize:13,whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis'}}>{name}</span>{r.quantity>1&&<span style={{fontSize:11,opacity:.8}}>x{r.quantity}</span>}<span style={{fontSize:10,background:'rgba(0,0,0,.3)',padding:'2px 6px',borderRadius:4}}>{r.employment_type==='fte'?'FTE':'CON'}</span></div><div style={{display:'flex',alignItems:'center',gap:8}}>{showCost&&<span style={{fontSize:12,fontWeight:600}}>{fmt(cost)}</span>}{!showAll&&<button onClick={e=>{e.stopPropagation();onDel(r.id)}} style={{background:'rgba(0,0,0,.3)',border:'none',color:'#fff',width:20,height:20,borderRadius:4,cursor:'pointer',fontSize:14,lineHeight:1}}>x</button>}</div><div className="rh rh-r" onMouseDown={e=>onMD(e,'right')}/></div>};
const MilestoneBar=({m,periods,onUpd,onEdit})=>{const[drag,setDrag]=React.useState(null);const left=(m.position/periods)*100;const onMD=e=>{e.stopPropagation();setDrag({startX:e.clientX,origPos:m.position})};React.useEffect(()=>{if(!drag)return;const onMM=e=>{const dx=e.clientX-drag.startX;const dp=Math.round(dx/(window.innerWidth*.7/periods));const np=Math.max(0,Math.min(periods-1,drag.origPos+dp));if(np!==m.position)onUpd(m.id,{position:np})};const onMU=()=>setDrag(null);window.addEventListener('mousemove',onMM);window.addEventListener('mouseup',onMU);return()=>{window.removeEventListener('mousemove',onMM);window.removeEventListener('mouseup',onMU)}},[drag]);return<div className="milestone" style={{left:left+'%'}} data-name={m.name} onMouseDown={onMD} onDoubleClick={()=>onEdit(m)}/>};

const AuthCtx=React.createContext(null);
const AuthProvider=({children})=>{
  const[user,setUser]=React.useState(null);const[profile,setProfile]=React.useState(null);const[org,setOrg]=React.useState(null);const[loading,setLoading]=React.useState(true);const[showTutorial,setShowTutorial]=React.useState(false);
  const loadData=async(uid)=>{const{data:p}=await supabase.from('profiles').select('*').eq('id',uid).single();setProfile(p);const{data:orgs}=await supabase.from('organizations').select('*').order('created_at');if(orgs?.length){setOrg(orgs[0]);if(!localStorage.getItem('pp_tutorial_v7'))setShowTutorial(true)}setLoading(false)};
  React.useEffect(()=>{supabase.auth.getSession().then(({data:{session}})=>{setUser(session?.user??null);if(session?.user)loadData(session.user.id);else setLoading(false)});const{data:{subscription}}=supabase.auth.onAuthStateChange((e,session)=>{setUser(session?.user??null);if(session?.user)loadData(session.user.id);else{setProfile(null);setOrg(null);setLoading(false)}});return()=>subscription.unsubscribe()},[]);
  const signUp=async(email,pw,name)=>{const{error}=await supabase.auth.signUp({email,password:pw,options:{data:{full_name:name},emailRedirectTo:window.location.origin+window.location.pathname}});if(error)throw error};
  const signIn=async(email,pw)=>{const{error}=await supabase.auth.signInWithPassword({email,password:pw});if(error)throw error};
  const signOut=()=>supabase.auth.signOut();
  const createOrg=async(name,logo)=>{const{data,error}=await supabase.from('organizations').insert({name,logo_url:logo||null,owner_id:user.id}).select().single();if(error)throw error;setOrg(data);setShowTutorial(true);return data};
  const updateOrg=async(u)=>{const{data,error}=await supabase.from('organizations').update(u).eq('id',org.id).select().single();if(error)throw error;setOrg(data)};
  const closeTutorial=()=>{localStorage.setItem('pp_tutorial_v7','1');setShowTutorial(false)};
  return<AuthCtx.Provider value={{user,profile,org,loading,signUp,signIn,signOut,createOrg,updateOrg,showTutorial,closeTutorial}}>{children}</AuthCtx.Provider>;
};
const useAuth=()=>React.useContext(AuthCtx);

const useProjects=(orgId)=>{
  const[projects,setProjects]=React.useState([]);const[loading,setLoading]=React.useState(true);
  const fetch=async()=>{if(!orgId)return;setLoading(true);const{data}=await supabase.from('projects').select('*,resources(*),milestones(*),cost_items(*)').eq('organization_id',orgId).order('created_at');setProjects(data||[]);setLoading(false)};
  React.useEffect(()=>{fetch()},[orgId]);
  const create=async(p)=>{const{data,error}=await supabase.from('projects').insert({...p,organization_id:orgId}).select().single();if(error)throw error;setProjects(prev=>[...prev,{...data,resources:[],milestones:[],cost_items:[]}]);return data};
  const update=async(pid,u)=>{const{error}=await supabase.from('projects').update(u).eq('id',pid);if(error)throw error;setProjects(prev=>prev.map(p=>p.id===pid?{...p,...u}:p))};
  const del=async(id)=>{const{error}=await supabase.from('projects').delete().eq('id',id);if(error)throw error;setProjects(prev=>prev.filter(p=>p.id!==id))};
  const addRes=async(pid,r)=>{const{data,error}=await supabase.from('resources').insert({...r,project_id:pid}).select().single();if(error)throw error;setProjects(prev=>prev.map(p=>p.id===pid?{...p,resources:[...(p.resources||[]),data]}:p))};
  const updateRes=async(pid,rid,u)=>{const{error}=await supabase.from('resources').update(u).eq('id',rid);if(error)throw error;setProjects(prev=>prev.map(p=>p.id===pid?{...p,resources:p.resources.map(r=>r.id===rid?{...r,...u}:r)}:p))};
  const delRes=async(pid,rid)=>{await supabase.from('resources').delete().eq('id',rid);setProjects(prev=>prev.map(p=>p.id===pid?{...p,resources:p.resources.filter(r=>r.id!==rid)}:p))};
  const addMilestone=async(pid,m)=>{const{data,error}=await supabase.from('milestones').insert({...m,project_id:pid}).select().single();if(error)throw error;setProjects(prev=>prev.map(p=>p.id===pid?{...p,milestones:[...(p.milestones||[]),data]}:p))};
  const updateMilestone=async(pid,mid,u)=>{const{error}=await supabase.from('milestones').update(u).eq('id',mid);if(error)throw error;setProjects(prev=>prev.map(p=>p.id===pid?{...p,milestones:(p.milestones||[]).map(m=>m.id===mid?{...m,...u}:m)}:p))};
  const delMilestone=async(pid,mid)=>{await supabase.from('milestones').delete().eq('id',mid);setProjects(prev=>prev.map(p=>p.id===pid?{...p,milestones:(p.milestones||[]).filter(m=>m.id!==mid)}:p))};
  const addCostItem=async(pid,c)=>{const{data,error}=await supabase.from('cost_items').insert({...c,project_id:pid}).select().single();if(error)throw error;setProjects(prev=>prev.map(p=>p.id===pid?{...p,cost_items:[...(p.cost_items||[]),data]}:p))};
  const updateCostItem=async(pid,cid,u)=>{const{error}=await supabase.from('cost_items').update(u).eq('id',cid);if(error)throw error;setProjects(prev=>prev.map(p=>p.id===pid?{...p,cost_items:(p.cost_items||[]).map(c=>c.id===cid?{...c,...u}:c)}:p))};
  const delCostItem=async(pid,cid)=>{await supabase.from('cost_items').delete().eq('id',cid);setProjects(prev=>prev.map(p=>p.id===pid?{...p,cost_items:(p.cost_items||[]).filter(c=>c.id!==cid)}:p))};
  return{projects,loading,create,update,del,addRes,updateRes,delRes,addMilestone,updateMilestone,delMilestone,addCostItem,updateCostItem,delCostItem,refresh:fetch};
};

const useResourceTypes=(orgId)=>{const[types,setTypes]=React.useState([]);React.useEffect(()=>{if(!orgId)return;supabase.from('resource_types').select('*').eq('organization_id',orgId).order('name').then(({data})=>setTypes(data||[]))},[orgId]);const add=async(t)=>{const{data,error}=await supabase.from('resource_types').insert({...t,organization_id:orgId}).select().single();if(error)throw error;setTypes(prev=>[...prev,data].sort((a,b)=>a.name.localeCompare(b.name)));return data};const update=async(id,u)=>{const{error}=await supabase.from('resource_types').update(u).eq('id',id);if(error)throw error;setTypes(prev=>prev.map(t=>t.id===id?{...t,...u}:t))};const del=async(id)=>{await supabase.from('resource_types').delete().eq('id',id);setTypes(prev=>prev.filter(t=>t.id!==id))};return{types,add,update,del}};

const useCostCategories=(orgId)=>{const[cats,setCats]=React.useState([]);React.useEffect(()=>{if(!orgId)return;supabase.from('cost_categories').select('*').eq('organization_id',orgId).order('sort_order').then(({data})=>setCats(data||[]))},[orgId]);return{cats}};

const useTeam=(orgId)=>{const[members,setMembers]=React.useState([]);const[invites,setInvites]=React.useState([]);const fetch=async()=>{if(!orgId)return;const{data:m}=await supabase.from('organization_members').select('*,profiles(*)').eq('organization_id',orgId);setMembers(m||[]);const{data:i}=await supabase.from('invitations').select('*').eq('organization_id',orgId).eq('status','pending');setInvites(i||[])};React.useEffect(()=>{fetch()},[orgId]);const invite=async(email,role)=>{const{error}=await supabase.from('invitations').insert({organization_id:orgId,email,role});if(error)throw error;fetch()};const cancelInvite=async(id)=>{await supabase.from('invitations').delete().eq('id',id);fetch()};return{members,invites,invite,cancelInvite}};

const Landing=({onStart,onSignup})=>{const{mob}=useWin();return<div style={{minHeight:'100vh',background:C.bg}}><nav style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:mob?'16px 20px':'20px 48px',borderBottom:'1px solid '+C.border}}><Logo size={mob?16:20}/><Btn onClick={onStart}>Sign In</Btn></nav><section style={{padding:mob?'60px 20px':'100px 48px',textAlign:'center',maxWidth:900,margin:'0 auto'}}><h1 style={{fontSize:mob?28:48,fontWeight:600,lineHeight:1.2,marginBottom:32,background:'linear-gradient(135deg,#fff,#94a3b8)',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent'}}>Resource Planning Made Simple</h1><div style={{display:'flex',flexDirection:'column',gap:16,maxWidth:700,margin:'0 auto 40px',textAlign:'left'}}><div style={{display:'flex',gap:14}}><span style={{fontSize:24}}>ðŸŽ¯</span><p style={{color:C.textS,margin:0}}>Drag-and-drop resource allocation for FTEs and consultants</p></div><div style={{display:'flex',gap:14}}><span style={{fontSize:24}}>ðŸ’°</span><p style={{color:C.textS,margin:0}}>Flexible cost categories with CAPEX/OPEX tracking</p></div><div style={{display:'flex',gap:14}}><span style={{fontSize:24}}>ðŸ“Š</span><p style={{color:C.textS,margin:0}}>Export to Excel with monthly breakdowns for PMO</p></div></div><Btn onClick={onSignup} v="accent" style={{padding:'16px 40px',fontSize:16}}>Start Free Trial</Btn></section></div>};

const AuthPage=({onBack,startMode='signin'})=>{const{signIn,signUp}=useAuth();const[mode,setMode]=React.useState(startMode);const[email,setEmail]=React.useState('');const[pw,setPw]=React.useState('');const[pw2,setPw2]=React.useState('');const[name,setName]=React.useState('');const[agreed,setAgreed]=React.useState(false);const[err,setErr]=React.useState('');const[ok,setOk]=React.useState('');const[ld,setLd]=React.useState(false);const pwErrs=mode==='signup'?validatePw(pw):[];const canSubmit=mode==='signup'?(pwErrs.length===0&&pw===pw2&&agreed&&name&&email):true;const go=async e=>{e.preventDefault();setErr('');setOk('');if(mode==='signup'&&pwErrs.length>0)return setErr('Password needs: '+pwErrs.join(', '));if(mode==='signup'&&pw!==pw2)return setErr('Passwords must match');if(mode==='signup'&&!agreed)return setErr('Please agree to terms');setLd(true);try{if(mode==='signup'){await signUp(email,pw,name);setOk('Check email to confirm')}else await signIn(email,pw)}catch(e){setErr(e.message)}setLd(false)};return<div style={{minHeight:'100vh',background:C.bg,display:'flex',flexDirection:'column'}}><nav style={{padding:'16px 32px',borderBottom:'1px solid '+C.border}}><Logo size={18} onClick={onBack}/></nav><div style={{flex:1,display:'flex',alignItems:'center',justifyContent:'center',padding:20}}><div style={{width:'100%',maxWidth:400}}><h2 style={{textAlign:'center',marginBottom:24}}>{mode==='signin'?'Sign In':'Create Account'}</h2><div style={{background:C.card,border:'1px solid '+C.border,borderRadius:12,padding:28}}>{err&&<div style={{background:C.err+'20',border:'1px solid '+C.err,borderRadius:6,padding:12,marginBottom:16,color:C.err,fontSize:14}}>{err}</div>}{ok&&<div style={{background:C.ok+'20',border:'1px solid '+C.ok,borderRadius:6,padding:12,marginBottom:16,color:C.ok,fontSize:14}}>{ok}</div>}<form onSubmit={go}>{mode==='signup'&&<Input label="Full Name" value={name} onChange={e=>setName(e.target.value)} required/>}<Input label="Email" type="email" value={email} onChange={e=>setEmail(e.target.value)} required/><Input label="Password" type="password" value={pw} onChange={e=>setPw(e.target.value)} required/>{mode==='signup'&&<><Input label="Confirm Password" type="password" value={pw2} onChange={e=>setPw2(e.target.value)} required/><Checkbox label="I agree to terms" checked={agreed} onChange={setAgreed}/></>}<Btn type="submit" disabled={ld||(mode==='signup'&&!canSubmit)} style={{width:'100%'}}>{ld?'...':mode==='signin'?'Sign In':'Sign Up'}</Btn></form><div style={{marginTop:20,textAlign:'center',fontSize:14}}>{mode==='signin'?<><span style={{color:C.textS}}>No account? </span><button onClick={()=>setMode('signup')} style={{background:'none',border:'none',color:C.accent,cursor:'pointer'}}>Sign up</button></>:<><span style={{color:C.textS}}>Have account? </span><button onClick={()=>setMode('signin')} style={{background:'none',border:'none',color:C.accent,cursor:'pointer'}}>Sign in</button></>}</div></div></div></div></div>};

const Onboarding=()=>{const{createOrg,profile,signOut}=useAuth();const[name,setName]=React.useState('');const[logo,setLogo]=React.useState('');const[ld,setLd]=React.useState(false);const[err,setErr]=React.useState('');const go=async e=>{e.preventDefault();if(!name.trim())return;setLd(true);setErr('');try{await createOrg(name.trim(),logo)}catch(e){setErr(e.message);setLd(false)}};return<div style={{minHeight:'100vh',background:C.bg}}><nav style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'16px 32px',borderBottom:'1px solid '+C.border}}><Logo/><Btn v="secondary" onClick={signOut}>Sign Out</Btn></nav><div style={{display:'flex',alignItems:'center',justifyContent:'center',minHeight:'calc(100vh - 65px)',padding:20}}><div style={{maxWidth:420,width:'100%',textAlign:'center'}}><h1 style={{fontSize:28,marginBottom:8}}>Welcome{profile?.full_name?', '+profile.full_name:''}!</h1><p style={{color:C.textS,marginBottom:32}}>Set up your organization</p><div style={{background:C.card,border:'1px solid '+C.border,borderRadius:12,padding:28,textAlign:'left'}}>{err&&<div style={{background:C.err+'20',border:'1px solid '+C.err,borderRadius:6,padding:12,marginBottom:16,color:C.err}}>{err}</div>}<form onSubmit={go}><Input label="Organization Name" value={name} onChange={e=>setName(e.target.value)} placeholder="Acme Inc" required/><Input label="Logo URL (optional)" value={logo} onChange={e=>setLogo(e.target.value)} placeholder="https://..."/><Btn type="submit" disabled={ld||!name.trim()} style={{width:'100%'}}>{ld?'Creating...':'Create Organization'}</Btn></form></div></div></div></div>};

const MainApp=()=>{
  const{user,profile,org,signOut,showTutorial,closeTutorial}=useAuth();
  const{mob,tab}=useWin();
  const{projects,loading:pL,create,update:updateProj,del,addRes,updateRes,delRes,addMilestone,updateMilestone,delMilestone,addCostItem,updateCostItem,delCostItem}=useProjects(org?.id);
  const{types:resourceTypes,add:addType,update:updateType,del:delType}=useResourceTypes(org?.id);
  const{cats:costCategories}=useCostCategories(org?.id);
  const{members,invites,invite,cancelInvite}=useTeam(org?.id);
  const[aPid,setAPid]=React.useState(null);
  const[view,setView]=React.useState('planner');
  const[periods,setPeriods]=React.useState(12);
  const[showAll,setShowAll]=React.useState(false);
  const[modal,setModal]=React.useState(null);
  const[edit,setEdit]=React.useState(null);
  const[saving,setSaving]=React.useState(false);
  const[mobMenu,setMobMenu]=React.useState(false);
  const[delPid,setDelPid]=React.useState(null);
  const[profileOpen,setProfileOpen]=React.useState(false);
  const emptyRes={type_id:'',name:'',rate:100,quantity:1,duration_periods:3,allocation:100,employment_type:'fte',cost_type:'capex',start_period:0,track_cost:true,track_hours:true};
  const emptyType={name:'',color:RCOLS[0],default_rate:100};
  const emptyMilestone={name:'',position:0};
  const emptyCostItem={category_id:'',name:'',description:'',amount:0,cost_type:'capex',timing:'lump',duration:1};
  const[nProj,setNProj]=React.useState({name:'',fy:'FY2025',time_unit:'months',scope:'',priority:3});
  const[nRes,setNRes]=React.useState(emptyRes);
  const[nType,setNType]=React.useState(emptyType);
  const[nMilestone,setNMilestone]=React.useState(emptyMilestone);
  const[nCostItem,setNCostItem]=React.useState(emptyCostItem);
  const[invEmail,setInvEmail]=React.useState('');
  const[invRole,setInvRole]=React.useState('member');
  React.useEffect(()=>{if(projects.length&&!aPid)setAPid(projects[0].id)},[projects]);
  React.useEffect(()=>{if(resourceTypes.length&&!nRes.type_id)setNRes(r=>({...r,type_id:resourceTypes[0]?.id||''}))},[resourceTypes]);
  React.useEffect(()=>{if(costCategories.length&&!nCostItem.category_id)setNCostItem(c=>({...c,category_id:costCategories[0]?.id||''}))},[costCategories]);
  const aP=projects.find(p=>p.id===aPid);
  const timeUnit=aP?.time_unit||'months';
  const getT=p=>{if(!p)return{fte:0,con:0,cost:0,tot:0,capex:0,opex:0,fteH:0,conH:0};const tu=p.time_unit||'months';const res=p.resources||[];const costs=p.cost_items||[];const fteR=res.filter(r=>r.employment_type==='fte');const conR=res.filter(r=>r.employment_type==='consultant');const fte=fteR.reduce((s,r)=>s+cCost(r,tu),0);const con=conR.reduce((s,r)=>s+cCost(r,tu),0);const costTotal=costs.reduce((s,c)=>s+(c.timing==='recurring'?c.amount*c.duration:c.amount),0);const laborCapex=res.filter(r=>r.cost_type==='capex').reduce((s,r)=>s+cCost(r,tu),0);const laborOpex=res.filter(r=>r.cost_type==='opex').reduce((s,r)=>s+cCost(r,tu),0);const costCapex=costs.filter(c=>c.cost_type==='capex').reduce((s,c)=>s+(c.timing==='recurring'?c.amount*c.duration:c.amount),0);const costOpex=costs.filter(c=>c.cost_type==='opex').reduce((s,c)=>s+(c.timing==='recurring'?c.amount*c.duration:c.amount),0);return{fte,con,cost:costTotal,tot:fte+con+costTotal,capex:laborCapex+costCapex,opex:laborOpex+costOpex,fteH:fteR.reduce((s,r)=>s+cHrs(r,tu),0),conH:conR.reduce((s,r)=>s+cHrs(r,tu),0)}};
  const T=showAll?projects.reduce((a,p)=>{const t=getT(p);return Object.keys(a).reduce((x,k)=>({...x,[k]:a[k]+t[k]}),{})},{fte:0,con:0,cost:0,tot:0,capex:0,opex:0,fteH:0,conH:0}):getT(aP);
  const doCreateProj=async()=>{if(!nProj.name.trim())return;setSaving(true);try{const p=await create({name:nProj.name.trim(),fiscal_year:nProj.fy,time_unit:nProj.time_unit,scope:nProj.scope,priority:nProj.priority,color:PCOLS[projects.length%PCOLS.length],start_date:new Date().toISOString().split('T')[0],created_by:user.id});setAPid(p.id);setShowAll(false);setModal(null);setNProj({name:'',fy:'FY2025',time_unit:'months',scope:'',priority:3})}catch(e){alert(e.message)}setSaving(false)};
  const doDelProj=async()=>{if(!delPid)return;setSaving(true);try{await del(delPid);setDelPid(null);if(aPid===delPid)setAPid(projects.find(p=>p.id!==delPid)?.id||null)}catch(e){alert(e.message)}setSaving(false)};
  const doSaveRes=async()=>{if(!aP)return;setSaving(true);try{if(edit)await updateRes(aP.id,edit.id,nRes);else await addRes(aP.id,nRes);setModal(null);setEdit(null);setNRes({...emptyRes,type_id:resourceTypes[0]?.id||''})}catch(e){alert(e.message)}setSaving(false)};
  const doSaveType=async()=>{if(!nType.name.trim())return;setSaving(true);try{if(edit)await updateType(edit.id,nType);else await addType(nType);setModal(null);setEdit(null);setNType(emptyType)}catch(e){alert(e.message)}setSaving(false)};
  const doDelType=async(id)=>{if(!confirm('Delete type?'))return;try{await delType(id)}catch(e){alert(e.message)}};
  const doSaveMilestone=async()=>{if(!aP||!nMilestone.name.trim())return;setSaving(true);try{if(edit)await updateMilestone(aP.id,edit.id,nMilestone);else await addMilestone(aP.id,nMilestone);setModal(null);setEdit(null);setNMilestone(emptyMilestone)}catch(e){alert(e.message)}setSaving(false)};
  const doDelMilestone=async()=>{if(!aP||!edit)return;setSaving(true);try{await delMilestone(aP.id,edit.id);setModal(null);setEdit(null)}catch(e){alert(e.message)}setSaving(false)};
  const doSaveCostItem=async()=>{if(!aP||!nCostItem.name.trim())return;setSaving(true);try{if(edit)await updateCostItem(aP.id,edit.id,nCostItem);else await addCostItem(aP.id,nCostItem);setModal(null);setEdit(null);setNCostItem({...emptyCostItem,category_id:costCategories[0]?.id||''})}catch(e){alert(e.message)}setSaving(false)};
  const doDelCostItem=async(cid)=>{if(!aP)return;try{await delCostItem(aP.id,cid)}catch(e){alert(e.message)}};
  const doInvite=async()=>{if(!invEmail.trim())return;setSaving(true);try{await invite(invEmail.trim(),invRole);setInvEmail('');alert('Invited!')}catch(e){alert(e.message)}setSaving(false)};
  const openEditRes=r=>{setEdit(r);setNRes({type_id:r.type_id,name:r.name,rate:r.rate,quantity:r.quantity,duration_periods:r.duration_periods,allocation:r.allocation,employment_type:r.employment_type,cost_type:r.cost_type,start_period:r.start_period,track_cost:r.track_cost!==false,track_hours:r.track_hours!==false});setModal('addRes')};
  const openEditMilestone=m=>{setEdit(m);setNMilestone({name:m.name,position:m.position});setModal('editMilestone')};
  const openEditCostItem=c=>{setEdit(c);setNCostItem({category_id:c.category_id,name:c.name,description:c.description||'',amount:c.amount,cost_type:c.cost_type,timing:c.timing,duration:c.duration||1});setModal('addCostItem')};
  const toggleTimeUnit=async()=>{if(!aP)return;const newUnit=timeUnit==='months'?'weeks':'months';try{await updateProj(aP.id,{time_unit:newUnit})}catch(e){alert(e.message)}};
  const updateScope=async(scope)=>{if(!aP)return;try{await updateProj(aP.id,{scope})}catch(e){alert(e.message)}};
  const updatePriority=async(priority)=>{if(!aP)return;try{await updateProj(aP.id,{priority:+priority})}catch(e){alert(e.message)}};
  
  const exportExcel=async()=>{
    if(!aP)return;
    const wb=new ExcelJS.Workbook();
    wb.creator='Portfolio Planner';
    const tu=aP.time_unit||'months';
    const startD=aP.start_date?new Date(aP.start_date):new Date();
    const res=aP.resources||[];
    const costs=aP.cost_items||[];
    const pr=PRIORITIES.find(x=>x.v===aP.priority);
    const ws1=wb.addWorksheet('Summary');
    ws1.columns=[{width:25},{width:40}];
    ws1.addRow(['Project Summary','']).font={bold:true,size:16};
    ws1.addRow([]);
    ws1.addRow(['Project Name',aP.name]);
    ws1.addRow(['Fiscal Year',aP.fiscal_year]);
    ws1.addRow(['Priority',pr?.l||'Medium']);
    ws1.addRow(['Scope',aP.scope||'Not defined']);
    ws1.addRow([]);
    ws1.addRow(['Financial Summary','']).font={bold:true};
    ws1.addRow(['Total Budget',T.tot]);
    ws1.addRow(['CAPEX',T.capex]);
    ws1.addRow(['OPEX',T.opex]);
    ws1.addRow([]);
    ws1.addRow(['Labor Hours','']).font={bold:true};
    ws1.addRow(['FTE Hours',T.fteH]);
    ws1.addRow(['Consultant Hours',T.conH]);
    ws1.getColumn(2).numFmt='$#,##0';
    const ws2=wb.addWorksheet('Cost Breakdown');
    ws2.columns=[{width:30},{width:20},{width:15},{width:15}];
    ws2.addRow(['Category/Item','Amount','Type','Timing']).font={bold:true};
    ws2.addRow(['LABOR','','','']).font={bold:true};
    ws2.addRow(['FTE Labor',T.fte,'Mixed','']);
    ws2.addRow(['Consultant Labor',T.con,'Mixed','']);
    const catGroups={};
    costs.forEach(c=>{const cat=costCategories.find(x=>x.id===c.category_id);const catName=cat?.name||'Other';if(!catGroups[catName])catGroups[catName]=[];catGroups[catName].push(c)});
    Object.entries(catGroups).forEach(([catName,items])=>{ws2.addRow([catName,'','','']).font={bold:true};items.forEach(c=>{const amt=c.timing==='recurring'?c.amount*c.duration:c.amount;ws2.addRow(['  '+c.name,amt,c.cost_type.toUpperCase(),c.timing])})});
    ws2.addRow([]);
    ws2.addRow(['TOTAL',T.tot,'','']).font={bold:true};
    ws2.getColumn(2).numFmt='$#,##0';
    const ws3=wb.addWorksheet('Hours by Month');
    const monthHeaders=['Resource','Type'];
    for(let i=0;i<periods;i++){monthHeaders.push(tu==='weeks'?'Wk '+(i+1):fmtM(addM(startD,i)))}
    monthHeaders.push('Total');
    ws3.addRow(monthHeaders).font={bold:true};
    res.forEach(r=>{const t=resourceTypes.find(x=>x.id===r.type_id);const name=r.name||t?.name||'Resource';const row=[name,r.employment_type==='fte'?'FTE':'Consultant'];const hrsPerPeriod=r.track_hours!==false?(tu==='weeks'?HPW:HPM)*r.quantity*(r.allocation/100):0;let total=0;for(let i=0;i<periods;i++){const inRange=i>=r.start_period&&i<r.start_period+r.duration_periods;row.push(inRange?hrsPerPeriod:0);if(inRange)total+=hrsPerPeriod}row.push(total);ws3.addRow(row)});
    const ws4=wb.addWorksheet('Costs by Month');
    ws4.addRow(monthHeaders).font={bold:true};
    res.forEach(r=>{const t=resourceTypes.find(x=>x.id===r.type_id);const name=r.name||t?.name||'Resource';const row=[name,r.employment_type==='fte'?'FTE':'Consultant'];const costPerPeriod=r.track_cost!==false?(r.rate||0)*(tu==='weeks'?HPW:HPM)*r.quantity*(r.allocation/100):0;let total=0;for(let i=0;i<periods;i++){const inRange=i>=r.start_period&&i<r.start_period+r.duration_periods;row.push(inRange?costPerPeriod:0);if(inRange)total+=costPerPeriod}row.push(total);ws4.addRow(row)});
    for(let i=3;i<=periods+3;i++){ws4.getColumn(i).numFmt='$#,##0'}
    const buf=await wb.xlsx.writeBuffer();
    const blob=new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;a.download=(aP.name.replace(/[^a-z0-9]/gi,'_'))+'_Budget.xlsx';a.click();
  };
  
  const pArr=Array.from({length:periods},(_,i)=>i);
  const startD=aP?.start_date?new Date(aP.start_date):new Date();
  const getD=i=>timeUnit==='weeks'?addW(startD,i):addM(startD,i);
  const allRes=showAll?projects.flatMap(p=>(p.resources||[]).map(r=>({...r,pCol:p.color}))):(aP?.resources||[]);
  const allMilestones=aP?.milestones||[];
  const allCosts=aP?.cost_items||[];
  const groupedCosts=costCategories.map(cat=>({...cat,items:allCosts.filter(c=>c.category_id===cat.id)})).filter(cat=>cat.items.length>0);
  if(pL)return<div className="loading"><div className="spinner"/></div>;
  return<>
    {showTutorial&&<Tutorial onClose={closeTutorial}/>}
    <Modal open={!!delPid} onClose={()=>setDelPid(null)} title="Delete Project?"><p style={{color:C.textS,marginBottom:20}}>This will permanently delete the project and all its resources, milestones, and costs.</p><div style={{display:'flex',gap:12}}><Btn v="secondary" onClick={()=>setDelPid(null)} style={{flex:1}}>Cancel</Btn><Btn v="danger" onClick={doDelProj} disabled={saving} style={{flex:1}}>Delete</Btn></div></Modal>
    <Modal open={modal==='newProj'} onClose={()=>setModal(null)} title="New Project"><Input label="Project Name" value={nProj.name} onChange={e=>setNProj({...nProj,name:e.target.value})} placeholder="e.g., ERP Implementation"/><Select label="Fiscal Year" value={nProj.fy} onChange={e=>setNProj({...nProj,fy:e.target.value})}>{FYS.map(f=><option key={f} value={f}>{f}</option>)}</Select><div style={{marginBottom:16}}><label style={{display:'block',fontSize:12,color:C.textS,marginBottom:6,textTransform:'uppercase'}}>Time Unit</label><div className="time-toggle" style={{width:'fit-content'}}><button onClick={()=>setNProj({...nProj,time_unit:'weeks'})} className={nProj.time_unit==='weeks'?'active':''}>Weeks</button><button onClick={()=>setNProj({...nProj,time_unit:'months'})} className={nProj.time_unit==='months'?'active':''}>Months</button></div></div><Textarea label="Scope (optional)" value={nProj.scope} onChange={e=>setNProj({...nProj,scope:e.target.value})} placeholder="Brief description of project scope..."/><Select label="Priority" value={nProj.priority} onChange={e=>setNProj({...nProj,priority:+e.target.value})}>{PRIORITIES.map(p=><option key={p.v} value={p.v}>{p.l}</option>)}</Select><Btn onClick={doCreateProj} disabled={saving||!nProj.name.trim()} style={{width:'100%'}}>Create</Btn></Modal>
    <Modal open={modal==='team'} onClose={()=>setModal(null)} title="Team Management" wide><div style={{marginBottom:24}}><h4 style={{marginBottom:12,color:C.textS}}>Invite Member</h4><div style={{display:'flex',gap:8}}><input value={invEmail} onChange={e=>setInvEmail(e.target.value)} placeholder="email@example.com" style={{flex:1,padding:12,background:C.bg,border:'1px solid '+C.border,borderRadius:6,color:C.text}}/><select value={invRole} onChange={e=>setInvRole(e.target.value)} style={{padding:12,background:C.bg,border:'1px solid '+C.border,borderRadius:6,color:C.text}}><option value="member">Member</option><option value="admin">Admin</option><option value="viewer">Viewer</option></select><Btn onClick={doInvite} disabled={saving}>Invite</Btn></div></div>{invites.length>0&&<div style={{marginBottom:24}}><h4 style={{marginBottom:12,color:C.textS}}>Pending Invitations</h4>{invites.map(inv=><div key={inv.id} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'10px 0',borderBottom:'1px solid '+C.border}}><span>{inv.email}</span><div style={{display:'flex',alignItems:'center',gap:8}}><span style={{fontSize:12,color:C.textM}}>{inv.role}</span><button onClick={()=>cancelInvite(inv.id)} style={{background:'none',border:'none',color:C.err,cursor:'pointer'}}>Cancel</button></div></div>)}</div>}<div><h4 style={{marginBottom:12,color:C.textS}}>Members</h4>{members.map(m=><div key={m.id} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'10px 0',borderBottom:'1px solid '+C.border}}><div><div style={{fontWeight:500}}>{m.profiles?.full_name||'User'}</div><div style={{fontSize:12,color:C.textM}}>{m.profiles?.email}</div></div><span style={{fontSize:12,color:m.role==='owner'?C.accent:C.textM}}>{m.role}</span></div>)}</div></Modal>
    <Modal open={modal==='report'} onClose={()=>setModal(null)} title="Project Report">{aP&&<><div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16,marginBottom:20}}><div style={{background:C.bg,padding:16,borderRadius:8}}><div style={{fontSize:12,color:C.textM,marginBottom:4}}>Total Budget</div><div style={{fontSize:24,fontWeight:700}}>{fmt(T.tot)}</div></div><div style={{background:C.bg,padding:16,borderRadius:8}}><div style={{fontSize:12,color:C.textM,marginBottom:4}}>CAPEX / OPEX</div><div style={{fontSize:18,fontWeight:600}}><span style={{color:C.capex}}>{fmt(T.capex)}</span> / <span style={{color:C.opex}}>{fmt(T.opex)}</span></div></div><div style={{background:C.bg,padding:16,borderRadius:8}}><div style={{fontSize:12,color:C.textM,marginBottom:4}}>FTE Hours</div><div style={{fontSize:18,fontWeight:600,color:C.fte}}>{T.fteH.toLocaleString()}h</div></div><div style={{background:C.bg,padding:16,borderRadius:8}}><div style={{fontSize:12,color:C.textM,marginBottom:4}}>Consultant Hours</div><div style={{fontSize:18,fontWeight:600,color:C.con}}>{T.conH.toLocaleString()}h</div></div></div><Btn v="accent" onClick={exportExcel} style={{width:'100%'}}>Export Excel</Btn></>}</Modal>
    <Modal open={modal==='addRes'} onClose={()=>{setModal(null);setEdit(null);setNRes({...emptyRes,type_id:resourceTypes[0]?.id||''})}} title={edit?'Edit Resource':'Add Resource'}>{resourceTypes.length===0?<div style={{padding:20,textAlign:'center',background:C.bg,borderRadius:8,marginBottom:16}}><p style={{color:C.textM,marginBottom:12}}>Create resource types first</p><Btn v="accent" onClick={()=>setModal('manageTypes')}>Create Types</Btn></div>:<><Select label="Type" value={nRes.type_id} onChange={e=>{const t=resourceTypes.find(r=>r.id===e.target.value);setNRes({...nRes,type_id:e.target.value,rate:edit?nRes.rate:(t?.default_rate||100)})}}>{resourceTypes.map(t=><option key={t.id} value={t.id}>{t.name}</option>)}</Select><Input label="Name (optional)" value={nRes.name} onChange={e=>setNRes({...nRes,name:e.target.value})} placeholder="e.g., John Smith"/><div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}><Input label="Rate/hr" type="number" value={nRes.rate} onChange={e=>setNRes({...nRes,rate:+e.target.value})}/><Input label="Qty" type="number" value={nRes.quantity} onChange={e=>setNRes({...nRes,quantity:+e.target.value})}/></div><div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}><Input label={'Start '+(timeUnit==='weeks'?'Week':'Month')} type="number" value={nRes.start_period} onChange={e=>setNRes({...nRes,start_period:+e.target.value})}/><Input label="Duration" type="number" value={nRes.duration_periods} onChange={e=>setNRes({...nRes,duration_periods:+e.target.value})}/></div><div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}><Select label="Allocation" value={nRes.allocation} onChange={e=>setNRes({...nRes,allocation:+e.target.value})}><option value={100}>100%</option><option value={75}>75%</option><option value={50}>50%</option><option value={25}>25%</option></Select><Select label="Employment" value={nRes.employment_type} onChange={e=>setNRes({...nRes,employment_type:e.target.value})}><option value="fte">FTE</option><option value="consultant">Consultant</option></Select></div><Select label="Cost Type" value={nRes.cost_type} onChange={e=>setNRes({...nRes,cost_type:e.target.value})}><option value="capex">CAPEX</option><option value="opex">OPEX</option></Select><div style={{background:C.bg,padding:16,borderRadius:8,marginBottom:16}}><div style={{marginBottom:8,fontWeight:600,fontSize:13}}>Tracking Options</div><Checkbox label="Track Cost" checked={nRes.track_cost} onChange={v=>setNRes({...nRes,track_cost:v})}/><Checkbox label="Track Hours" checked={nRes.track_hours} onChange={v=>setNRes({...nRes,track_hours:v})}/></div>{nRes.track_cost&&<div style={{background:C.bg,padding:12,borderRadius:6,marginBottom:16,textAlign:'center'}}><span style={{color:C.textM}}>Est: </span><span style={{fontSize:18,fontWeight:600}}>{fmt(cCost(nRes,timeUnit))}</span></div>}<Btn onClick={doSaveRes} disabled={saving} style={{width:'100%'}}>{edit?'Save':'Add'}</Btn></>}</Modal>
    <Modal open={modal==='manageTypes'} onClose={()=>{setModal(null);setEdit(null);setNType(emptyType)}} title="Resource Types">{resourceTypes.length>0&&<div style={{marginBottom:20}}>{resourceTypes.map(t=><div key={t.id} style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'12px 0',borderBottom:'1px solid '+C.border}}><div style={{display:'flex',alignItems:'center',gap:10}}><div style={{width:16,height:16,borderRadius:4,background:t.color}}/><span>{t.name}</span><span style={{color:C.textM,fontSize:12}}>{fmt(t.default_rate)}/hr</span></div><div style={{display:'flex',gap:8}}><button onClick={()=>{setEdit(t);setNType({name:t.name,color:t.color,default_rate:t.default_rate});setModal('addType')}} style={{background:'none',border:'none',color:C.textS,cursor:'pointer'}}>Edit</button><button onClick={()=>doDelType(t.id)} style={{background:'none',border:'none',color:C.err,cursor:'pointer'}}>x</button></div></div>)}</div>}<Btn v="accent" onClick={()=>{setEdit(null);setNType(emptyType);setModal('addType')}} style={{width:'100%'}}>+ Add Type</Btn></Modal>
    <Modal open={modal==='addType'} onClose={()=>{setModal('manageTypes');setEdit(null);setNType(emptyType)}} title={edit?'Edit Type':'Add Type'}><Input label="Name" value={nType.name} onChange={e=>setNType({...nType,name:e.target.value})} placeholder="e.g., Developer"/><Input label="Default Rate ($/hr)" type="number" value={nType.default_rate} onChange={e=>setNType({...nType,default_rate:+e.target.value})}/><div style={{marginBottom:16}}><label style={{fontSize:12,color:C.textS,marginBottom:6,display:'block',textTransform:'uppercase'}}>Color</label><div style={{display:'flex',gap:8,flexWrap:'wrap'}}>{RCOLS.map(c=><button key={c} onClick={()=>setNType({...nType,color:c})} style={{width:32,height:32,borderRadius:6,background:c,border:nType.color===c?'3px solid #fff':'none',cursor:'pointer'}}/>)}</div></div><Btn onClick={doSaveType} disabled={saving||!nType.name.trim()} style={{width:'100%'}}>{edit?'Save':'Add'}</Btn></Modal>
    <Modal open={modal==='addMilestone'} onClose={()=>{setModal(null);setNMilestone(emptyMilestone)}} title="Add Milestone"><Input label="Name" value={nMilestone.name} onChange={e=>setNMilestone({...nMilestone,name:e.target.value})} placeholder="e.g., Go Live"/><Input label={'Position ('+(timeUnit==='weeks'?'week':'month')+' #)'} type="number" value={nMilestone.position} onChange={e=>setNMilestone({...nMilestone,position:+e.target.value})}/><Btn onClick={doSaveMilestone} disabled={saving||!nMilestone.name.trim()} style={{width:'100%'}}>Add</Btn></Modal>
    <Modal open={modal==='editMilestone'} onClose={()=>{setModal(null);setEdit(null);setNMilestone(emptyMilestone)}} title="Edit Milestone"><Input label="Name" value={nMilestone.name} onChange={e=>setNMilestone({...nMilestone,name:e.target.value})}/><Input label="Position" type="number" value={nMilestone.position} onChange={e=>setNMilestone({...nMilestone,position:+e.target.value})}/><div style={{display:'flex',gap:12}}><Btn v="danger" onClick={doDelMilestone} disabled={saving} style={{flex:1}}>Delete</Btn><Btn onClick={doSaveMilestone} disabled={saving} style={{flex:1}}>Save</Btn></div></Modal>
    <Modal open={modal==='addCostItem'} onClose={()=>{setModal(null);setEdit(null);setNCostItem({...emptyCostItem,category_id:costCategories[0]?.id||''})}} title={edit?'Edit Cost':'Add Cost'}><Select label="Category" value={nCostItem.category_id} onChange={e=>setNCostItem({...nCostItem,category_id:e.target.value})}>{costCategories.map(c=><option key={c.id} value={c.id}>{c.icon} {c.name}</option>)}</Select><Input label="Name (subcategory)" value={nCostItem.name} onChange={e=>setNCostItem({...nCostItem,name:e.target.value})} placeholder="e.g., Oracle License"/><Input label="Description (optional)" value={nCostItem.description} onChange={e=>setNCostItem({...nCostItem,description:e.target.value})}/><div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}><Select label="Cost Type" value={nCostItem.cost_type} onChange={e=>setNCostItem({...nCostItem,cost_type:e.target.value})}><option value="capex">CAPEX</option><option value="opex">OPEX</option></Select><Select label="Timing" value={nCostItem.timing} onChange={e=>setNCostItem({...nCostItem,timing:e.target.value})}><option value="lump">One-time</option><option value="recurring">Recurring</option></Select></div>{nCostItem.timing==='recurring'?<div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}><Input label="Amount per period" type="number" value={nCostItem.amount} onChange={e=>setNCostItem({...nCostItem,amount:+e.target.value})}/><Input label="# of periods" type="number" value={nCostItem.duration} onChange={e=>setNCostItem({...nCostItem,duration:+e.target.value})}/></div>:<Input label="Amount" type="number" value={nCostItem.amount} onChange={e=>setNCostItem({...nCostItem,amount:+e.target.value})}/>}<div style={{background:C.bg,padding:12,borderRadius:6,marginBottom:16,textAlign:'center'}}><span style={{color:C.textM}}>Total: </span><span style={{fontSize:18,fontWeight:600}}>{fmt(nCostItem.timing==='recurring'?nCostItem.amount*nCostItem.duration:nCostItem.amount)}</span></div><Btn onClick={doSaveCostItem} disabled={saving||!nCostItem.name.trim()} style={{width:'100%'}}>{edit?'Save':'Add'}</Btn></Modal>
    <Modal open={modal==='editScope'} onClose={()=>setModal(null)} title="Edit Scope & Priority"><Textarea label="Scope" value={aP?.scope||''} onChange={e=>updateScope(e.target.value)} placeholder="What is this project about?"/><Select label="Priority" value={aP?.priority||3} onChange={e=>updatePriority(e.target.value)}>{PRIORITIES.map(p=><option key={p.v} value={p.v}>{p.l}</option>)}</Select><Btn onClick={()=>setModal(null)} style={{width:'100%'}}>Done</Btn></Modal>

    <nav style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:mob?'12px 16px':'16px 32px',borderBottom:'1px solid '+C.border,background:C.card}}>
      <div style={{display:'flex',alignItems:'center',gap:12}}>
        {org?.logo_url&&<img src={org.logo_url} style={{height:32,borderRadius:4}} onError={e=>e.target.style.display='none'}/>}
        <Logo size={mob?16:18}/>
        {!mob&&org&&<span style={{marginLeft:8,fontSize:14,color:C.accent2,fontWeight:500,padding:'4px 10px',background:C.accent2+'15',borderRadius:6}}>{org.name}</span>}
      </div>
      {mob?<button onClick={()=>setMobMenu(!mobMenu)} style={{background:'transparent',border:'none',color:C.text,fontSize:24,cursor:'pointer'}}>â˜°</button>:
      <div style={{display:'flex',alignItems:'center',gap:8}}>
        <Btn v="secondary" onClick={()=>setModal('team')} style={{padding:'8px 16px'}}>Team</Btn>
        <Btn v="secondary" onClick={()=>setModal('report')} style={{padding:'8px 16px'}}>Report</Btn>
        <div className="dropdown">
          <Btn v="secondary" onClick={()=>setProfileOpen(!profileOpen)} style={{padding:'8px 12px',display:'flex',alignItems:'center',gap:8}}>
            <span style={{width:28,height:28,borderRadius:14,background:C.accent,display:'flex',alignItems:'center',justifyContent:'center',fontSize:12,fontWeight:600}}>{(profile?.full_name||'U')[0]}</span>
            <span style={{fontSize:12}}>â–¼</span>
          </Btn>
          {profileOpen&&<div className="dropdown-menu" onClick={()=>setProfileOpen(false)}>
            <div style={{padding:'12px 16px',borderBottom:'1px solid '+C.border}}><div style={{fontWeight:500}}>{profile?.full_name}</div><div style={{fontSize:12,color:C.textM}}>{profile?.email}</div></div>
            <div className="dropdown-item" onClick={signOut}>Sign Out</div>
          </div>}
        </div>
      </div>}
    </nav>
    {mob&&mobMenu&&<div style={{padding:16,borderBottom:'1px solid '+C.border,background:C.card,display:'flex',flexDirection:'column',gap:8}}><Btn v="secondary" onClick={()=>{setModal('team');setMobMenu(false)}} style={{width:'100%'}}>Team</Btn><Btn v="secondary" onClick={()=>{setModal('report');setMobMenu(false)}} style={{width:'100%'}}>Report</Btn><Btn v="secondary" onClick={signOut} style={{width:'100%'}}>Sign Out</Btn></div>}

    <div style={{padding:mob?16:'24px 32px'}}>
      <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:16,flexWrap:'wrap'}}>
        <button onClick={()=>setShowAll(!showAll)} style={{padding:'10px 16px',border:showAll?'2px solid '+C.accent:'1px solid '+C.border,borderRadius:8,background:showAll?C.accent+'15':'transparent',color:showAll?C.text:C.textS,cursor:'pointer',fontWeight:600}}>Portfolio</button>
        {projects.map(p=>{const pr=PRIORITIES.find(x=>x.v===p.priority);return<div key={p.id} style={{position:'relative'}}><button onClick={()=>{setAPid(p.id);setShowAll(false)}} style={{padding:'10px 16px',paddingRight:!showAll&&aPid===p.id?36:16,border:!showAll&&aPid===p.id?'2px solid '+p.color:'1px solid '+C.border,borderRadius:8,background:!showAll&&aPid===p.id?p.color+'15':'transparent',color:!showAll&&aPid===p.id?C.text:C.textS,cursor:'pointer',fontWeight:500,display:'flex',alignItems:'center',gap:8}}><div style={{width:10,height:10,borderRadius:3,background:p.color}}/>{p.name}{pr&&<span className="priority-badge" style={{background:pr.c+'30',color:pr.c}}>{pr.l}</span>}</button>{!showAll&&aPid===p.id&&<button onClick={e=>{e.stopPropagation();setDelPid(p.id)}} style={{position:'absolute',right:8,top:'50%',transform:'translateY(-50%)',background:'transparent',border:'none',color:C.textM,cursor:'pointer',fontSize:16}}>x</button>}</div>})}
        <button onClick={()=>setModal('newProj')} style={{padding:'10px 20px',border:'2px dashed '+C.borderL,borderRadius:8,background:'transparent',color:C.textS,cursor:'pointer',fontWeight:600}}>+ New Project</button>
      </div>

      {projects.length===0&&<div style={{textAlign:'center',padding:'80px 20px',background:C.card,borderRadius:12,border:'1px solid '+C.border}}><div style={{fontSize:48,marginBottom:16}}>ðŸ“</div><h2 style={{marginBottom:8}}>Create Your First Project</h2><p style={{color:C.textS,marginBottom:24}}>Start planning resources and tracking costs.</p><Btn v="accent" onClick={()=>setModal('newProj')}>+ Create Project</Btn></div>}

      {projects.length>0&&<>
        {!showAll&&aP&&<div style={{display:'flex',gap:8,marginBottom:16,flexWrap:'wrap'}}>
          <button onClick={()=>setView('planner')} style={{padding:'10px 20px',border:view==='planner'?'2px solid '+C.text:'1px solid '+C.border,borderRadius:8,background:view==='planner'?'rgba(255,255,255,.08)':'transparent',color:view==='planner'?C.text:C.textS,cursor:'pointer',fontWeight:500}}>Planner</button>
          <button onClick={()=>setView('budget')} style={{padding:'10px 20px',border:view==='budget'?'2px solid '+C.text:'1px solid '+C.border,borderRadius:8,background:view==='budget'?'rgba(255,255,255,.08)':'transparent',color:view==='budget'?C.text:C.textS,cursor:'pointer',fontWeight:500}}>Budget</button>
        </div>}

        {!showAll&&aP&&<div style={{background:C.card,border:'1px solid '+C.border,borderRadius:10,padding:16,marginBottom:16,display:'flex',justifyContent:'space-between',alignItems:'flex-start',gap:16,flexWrap:'wrap'}}>
          <div style={{flex:1,minWidth:200}}>
            <div style={{fontSize:12,color:C.textM,marginBottom:4}}>SCOPE</div>
            <div style={{color:aP.scope?C.text:C.textM,fontSize:14}}>{aP.scope||'Not defined - click Edit'}</div>
          </div>
          <div>
            <div style={{fontSize:12,color:C.textM,marginBottom:4}}>PRIORITY</div>
            {(()=>{const pr=PRIORITIES.find(x=>x.v===aP.priority);return<span className="priority-badge" style={{background:(pr?.c||'#666')+'30',color:pr?.c||'#666'}}>{pr?.l||'Medium'}</span>})()}
          </div>
          <button onClick={()=>setModal('editScope')} style={{background:'none',border:'1px solid '+C.border,borderRadius:6,padding:'6px 12px',color:C.textS,cursor:'pointer',fontSize:12}}>Edit</button>
        </div>}

        <div style={{display:'grid',gridTemplateColumns:mob?'repeat(2,1fr)':tab?'repeat(4,1fr)':'repeat(6,1fr)',gap:12,marginBottom:24}}>
          {[{l:'Total Budget',v:fmt(T.tot),c:C.text},{l:'CAPEX',v:fmt(T.capex),c:C.capex},{l:'OPEX',v:fmt(T.opex),c:C.opex},{l:'FTE Hours',v:T.fteH.toLocaleString()+'h',c:C.fte},{l:'FTE Cost',v:fmt(T.fte),c:C.fte},{l:'Consultant',v:fmt(T.con),c:C.con}].map((d,i)=><div key={i} style={{background:C.card,border:'1px solid '+C.border,borderRadius:10,padding:14}}><div style={{fontSize:11,color:C.textS,marginBottom:4,textTransform:'uppercase'}}>{d.l}</div><div style={{fontSize:mob?16:20,fontWeight:700,color:d.c}}>{d.v}</div></div>)}
        </div>

        {(showAll||view==='planner')&&<>
          <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:16,padding:14,background:C.card,borderRadius:10,border:'1px solid '+C.border,flexWrap:'wrap'}}>
            {!showAll&&aP&&<div className="time-toggle"><button onClick={toggleTimeUnit} className={timeUnit==='weeks'?'active':''}>Weeks</button><button onClick={toggleTimeUnit} className={timeUnit==='months'?'active':''}>Months</button></div>}
            <div style={{display:'flex',alignItems:'center',gap:8}}><button onClick={()=>setPeriods(p=>Math.max(4,p-2))} style={{width:32,height:32,border:'1px solid '+C.border,borderRadius:6,background:C.bg,color:C.text,cursor:'pointer'}}>-</button><span style={{minWidth:30,textAlign:'center',fontWeight:500}}>{periods}</span><button onClick={()=>setPeriods(p=>Math.min(52,p+2))} style={{width:32,height:32,border:'1px solid '+C.border,borderRadius:6,background:C.bg,color:C.text,cursor:'pointer'}}>+</button><span style={{color:C.textS,marginLeft:4}}>{timeUnit}</span></div>
            {!showAll&&<span style={{color:C.textS,fontSize:13}}>Drag to move | Edges to resize | Double-click to edit</span>}
          </div>
          {!showAll&&aP&&<div style={{display:'flex',gap:8,marginBottom:16,flexWrap:'wrap'}}>
            <button onClick={()=>{setEdit(null);setNRes({...emptyRes,type_id:resourceTypes[0]?.id||''});setModal('addRes')}} style={{padding:'12px 20px',background:C.accent,border:'none',borderRadius:8,color:'#fff',fontWeight:600,cursor:'pointer'}}>+ Add Resource</button>
            <button onClick={()=>setModal('manageTypes')} style={{padding:'12px 20px',background:'transparent',border:'1px solid '+C.border,borderRadius:8,color:C.textS,fontWeight:500,cursor:'pointer'}}>Types</button>
            <button onClick={()=>{setNMilestone(emptyMilestone);setModal('addMilestone')}} style={{padding:'12px 20px',background:'transparent',border:'1px solid '+C.milestone,borderRadius:8,color:C.milestone,fontWeight:500,cursor:'pointer'}}>+ Milestone</button>
          </div>}
          <div style={{background:C.card,borderRadius:10,border:'1px solid '+C.border,overflow:'hidden',overflowX:'auto'}}>
            <div style={{minWidth:mob?800:'auto'}}>
              <div style={{display:'grid',gridTemplateColumns:'repeat('+periods+',1fr)',borderBottom:'1px solid '+C.border}}>{pArr.map((p,i)=><div key={p} style={{padding:'10px 4px',textAlign:'center',fontSize:11,color:C.textS,fontWeight:500,borderRight:i<pArr.length-1?'1px solid '+C.border:'none'}}>{timeUnit==='weeks'?fmtW(getD(p)):fmtM(getD(p))}</div>)}</div>
              <div style={{position:'relative',minHeight:Math.max(180,allRes.length*54+50),padding:'30px 0 10px 0'}}>
                {pArr.map((_,i)=><div key={i} style={{position:'absolute',left:(i/periods)*100+'%',top:0,bottom:0,width:1,background:C.border,opacity:.3}}/>)}
                {allMilestones.map(m=><MilestoneBar key={m.id} m={m} periods={periods} onUpd={(mid,u)=>updateMilestone(aP.id,mid,u)} onEdit={openEditMilestone}/>)}
                {allRes.map((r,idx)=>{const t=resourceTypes.find(x=>x.id===r.type_id);const col=showAll?r.pCol:t?.color||'#888';return<RBar key={r.id} r={r} idx={idx} periods={periods} color={col} showAll={showAll} resourceTypes={resourceTypes} timeUnit={timeUnit} onUpd={(rid,u)=>updateRes(aP.id,rid,u)} onDel={rid=>delRes(aP.id,rid)} onEdit={openEditRes}/>})}
                {allRes.length===0&&<div style={{display:'flex',alignItems:'center',justifyContent:'center',height:180,color:C.textM}}>Add resources to see them here</div>}
              </div>
            </div>
          </div>
        </>}

        {!showAll&&view==='budget'&&aP&&<div style={{display:'flex',flexDirection:'column',gap:16}}>
          <div className="cost-cat">
            <div className="cost-cat-header"><div style={{display:'flex',alignItems:'center',gap:10}}><span style={{fontSize:20}}>ðŸ‘¥</span><span style={{fontWeight:600}}>Labor</span></div><span style={{fontWeight:700,color:C.fte}}>{fmt(T.fte+T.con)}</span></div>
            <div>
              <div style={{padding:'12px 18px',borderBottom:'1px solid '+C.border,display:'flex',justifyContent:'space-between'}}><div><span style={{fontWeight:500}}>FTE Labor</span><span style={{marginLeft:12,color:C.textM,fontSize:13}}>{T.fteH.toLocaleString()} hrs</span></div><span style={{fontWeight:600,color:C.fte}}>{fmt(T.fte)}</span></div>
              {(aP.resources||[]).filter(r=>r.employment_type==='fte').map(r=>{const t=resourceTypes.find(x=>x.id===r.type_id);return<div key={r.id} className="cost-item" onClick={()=>openEditRes(r)}><div><span style={{color:C.textS}}>{r.name||t?.name||'Resource'}</span>{r.track_cost===false&&<span style={{marginLeft:8,fontSize:11,color:C.textM}}>(no cost)</span>}</div><span>{r.track_cost!==false?fmt(cCost(r,timeUnit)):'â€”'}</span></div>})}
              <div style={{padding:'12px 18px',borderTop:'1px solid '+C.border,borderBottom:'1px solid '+C.border,display:'flex',justifyContent:'space-between'}}><div><span style={{fontWeight:500}}>Consultants</span><span style={{marginLeft:12,color:C.textM,fontSize:13}}>{T.conH.toLocaleString()} hrs</span></div><span style={{fontWeight:600,color:C.con}}>{fmt(T.con)}</span></div>
              {(aP.resources||[]).filter(r=>r.employment_type==='consultant').map(r=>{const t=resourceTypes.find(x=>x.id===r.type_id);return<div key={r.id} className="cost-item" onClick={()=>openEditRes(r)}><div><span style={{color:C.textS}}>{r.name||t?.name||'Resource'}</span></div><span>{fmt(cCost(r,timeUnit))}</span></div>})}
            </div>
          </div>

          {groupedCosts.map(cat=><div key={cat.id} className="cost-cat">
            <div className="cost-cat-header"><div style={{display:'flex',alignItems:'center',gap:10}}><span style={{fontSize:20}}>{cat.icon}</span><span style={{fontWeight:600}}>{cat.name}</span></div><span style={{fontWeight:700}}>{fmt(cat.items.reduce((s,c)=>s+(c.timing==='recurring'?c.amount*c.duration:c.amount),0))}</span></div>
            <div>{cat.items.map(c=><div key={c.id} className="cost-item" onClick={()=>openEditCostItem(c)}><div><span>{c.name}</span><span style={{marginLeft:10,fontSize:11,padding:'2px 6px',borderRadius:3,background:c.cost_type==='capex'?C.capex+'30':C.opex+'30',color:c.cost_type==='capex'?C.capex:C.opex}}>{c.cost_type.toUpperCase()}</span>{c.description&&<div style={{fontSize:12,color:C.textM}}>{c.description}</div>}</div><div style={{display:'flex',alignItems:'center',gap:12}}><span style={{fontWeight:600}}>{fmt(c.timing==='recurring'?c.amount*c.duration:c.amount)}</span><button onClick={e=>{e.stopPropagation();doDelCostItem(c.id)}} style={{background:'none',border:'none',color:C.textM,cursor:'pointer'}}>x</button></div></div>)}</div>
          </div>)}

          <div style={{background:C.card,border:'2px dashed '+C.borderL,borderRadius:10,padding:20,textAlign:'center'}}>
            <button onClick={()=>{setEdit(null);setNCostItem({...emptyCostItem,category_id:costCategories[0]?.id||''});setModal('addCostItem')}} style={{padding:'14px 28px',background:C.accent,border:'none',borderRadius:8,color:'#fff',fontWeight:600,cursor:'pointer',fontSize:14}}>+ Add Cost</button>
            <p style={{color:C.textM,fontSize:12,marginTop:12}}>Select a category and name your cost item</p>
          </div>
        </div>}
      </>}
    </div>
  </div>;
};

const App=()=>{const{user,org,loading}=useAuth();const[page,setPage]=React.useState('landing');const[authMode,setAuthMode]=React.useState('signin');if(loading)return<div className="loading"><div className="spinner"/></div>;if(user&&!org)return<Onboarding/>;if(user&&org)return<MainApp/>;if(page==='auth')return<AuthPage onBack={()=>setPage('landing')} startMode={authMode}/>;return<Landing onStart={()=>{setAuthMode('signin');setPage('auth')}} onSignup={()=>{setAuthMode('signup');setPage('auth')}}/>};
const Root=()=><AuthProvider><App/></AuthProvider>;
ReactDOM.createRoot(document.getElementById('root')).render(<Root/>);
</script>
</body>
</html>
