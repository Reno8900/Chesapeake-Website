<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Portfolio Planner | Chesapeake Systems</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',-apple-system,sans-serif;background:#0a0a0a;color:#fff;min-height:100vh}
    .loading{display:flex;align-items:center;justify-content:center;min-height:100vh;flex-direction:column;gap:16px}
    .spinner{width:40px;height:40px;border:3px solid #222;border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    ::-webkit-scrollbar{width:8px;height:8px}
    ::-webkit-scrollbar-track{background:#111}
    ::-webkit-scrollbar-thumb{background:#333;border-radius:4px}
    input:focus,select:focus,button:focus{outline:2px solid #fff;outline-offset:2px}
    .rbar{position:absolute;height:44px;border-radius:6px;display:flex;align-items:center;padding:0 12px;justify-content:space-between;cursor:grab;user-select:none}
    .rbar:hover{box-shadow:0 0 0 2px rgba(255,255,255,0.3)}
    .rbar.drag{cursor:grabbing;box-shadow:0 0 0 2px #fff;z-index:100}
    .rh{position:absolute;top:0;bottom:0;width:12px;cursor:ew-resize}
    .rh::after{content:'';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:3px;height:20px;background:rgba(255,255,255,0.3);border-radius:2px}
    .rbar:hover .rh::after{background:rgba(255,255,255,0.6)}
    .rh-l{left:0}.rh-r{right:0}
  </style>
</head>
<body>
<div id="root"><div class="loading"><div class="spinner"></div><span style="color:#666">Loading...</span></div></div>
<script type="text/babel">
const SUPABASE_URL='https://lzmstiaexrelqviksdjt.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx6bXN0aWFleHJlbHF2aWtzZGp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1OTA3MDAsImV4cCI6MjA4NDE2NjcwMH0.Ys-BX1yVk-31xQg5hUsyBxvFTHPyaocbOsuUvXXxf-k';
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
const C={bg:'#0a0a0a',card:'#111',border:'#222',borderL:'#333',text:'#fff',textS:'#888',textM:'#666',capex:'#3b82f6',opex:'#ec4899',fte:'#22c55e',con:'#f97316',err:'#ef4444',ok:'#22c55e'};
const RTS=[{id:'developer',name:'Developer',color:'#3B82F6',rate:150},{id:'designer',name:'Designer',color:'#EC4899',rate:125},{id:'pm',name:'Project Manager',color:'#10B981',rate:130},{id:'analyst',name:'Analyst',color:'#F59E0B',rate:110},{id:'qa',name:'QA Engineer',color:'#8B5CF6',rate:100},{id:'devops',name:'DevOps',color:'#EF4444',rate:140},{id:'architect',name:'Architect',color:'#06b6d4',rate:175}];
const CCS=[{id:'software',name:'Software & Licensing',ct:'capex',tm:'lump'},{id:'hardware',name:'Hardware',ct:'capex',tm:'lump'},{id:'cloud',name:'Cloud & Hosting',ct:'opex',tm:'recurring'},{id:'training',name:'Training',ct:'capex',tm:'lump'},{id:'travel',name:'Travel',ct:'opex',tm:'lump'},{id:'migration',name:'Data Migration',ct:'capex',tm:'lump'},{id:'security',name:'Security & Compliance',ct:'opex',tm:'lump'},{id:'maintenance',name:'Maintenance & Support',ct:'opex',tm:'recurring'},{id:'contingency',name:'Contingency',ct:'capex',tm:'lump'},{id:'other',name:'Other',ct:'opex',tm:'lump'}];
const FYS=['FY2024','FY2025','FY2026','FY2027','FY2028'];
const PCOLS=['#3B82F6','#10B981','#F59E0B','#EF4444','#8B5CF6','#EC4899','#06b6d4','#84cc16'];
const HPM=160;
const fmt=n=>new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:0,maximumFractionDigits:0}).format(n);
const addM=(d,m)=>{const r=new Date(d);r.setMonth(r.getMonth()+m);return r};
const fmtM=d=>d.toLocaleDateString('en-US',{month:'short',year:'numeric'});
const cCost=r=>r.rate*r.duration_periods*HPM*r.quantity*(r.allocation/100);
const cHrs=r=>r.duration_periods*HPM*r.quantity*(r.allocation/100);
const useWin=()=>{const[w,sW]=React.useState(window.innerWidth);React.useEffect(()=>{const h=()=>sW(window.innerWidth);window.addEventListener('resize',h);return()=>window.removeEventListener('resize',h)},[]);return{w,mob:w<768,tab:w>=768&&w<1024}};

const AuthCtx=React.createContext(null);
const AuthProvider=({children})=>{
  const[user,setUser]=React.useState(null);
  const[profile,setProfile]=React.useState(null);
  const[org,setOrg]=React.useState(null);
  const[loading,setLoading]=React.useState(true);
  const loadData=async(uid)=>{
    const{data:p}=await supabase.from('profiles').select('*').eq('id',uid).single();
    setProfile(p);
    const{data:orgs}=await supabase.from('organizations').select('*').order('created_at');
    if(orgs?.length)setOrg(orgs[0]);
    setLoading(false);
  };
  React.useEffect(()=>{
    supabase.auth.getSession().then(({data:{session}})=>{
      setUser(session?.user??null);
      if(session?.user)loadData(session.user.id);else setLoading(false);
    });
    const{data:{subscription}}=supabase.auth.onAuthStateChange((e,session)=>{
      setUser(session?.user??null);
      if(session?.user)loadData(session.user.id);else{setProfile(null);setOrg(null);setLoading(false);}
    });
    return()=>subscription.unsubscribe();
  },[]);
  const signUp=async(email,pw,name)=>{const{error}=await supabase.auth.signUp({email,password:pw,options:{data:{full_name:name},emailRedirectTo:window.location.origin+window.location.pathname}});if(error)throw error};
  const signIn=async(email,pw)=>{const{error}=await supabase.auth.signInWithPassword({email,password:pw});if(error)throw error};
  const signOut=()=>supabase.auth.signOut();
  const resetPw=async(email)=>{const{error}=await supabase.auth.resetPasswordForEmail(email,{redirectTo:window.location.origin+window.location.pathname});if(error)throw error};
  const createOrg=async(name)=>{const{data,error}=await supabase.from('organizations').insert({name,owner_id:user.id}).select().single();if(error)throw error;setOrg(data);return data};
  return<AuthCtx.Provider value={{user,profile,org,loading,signUp,signIn,signOut,resetPw,createOrg,setOrg}}>{children}</AuthCtx.Provider>;
};
const useAuth=()=>React.useContext(AuthCtx);

const useProjects=(orgId)=>{
  const[projects,setProjects]=React.useState([]);
  const[loading,setLoading]=React.useState(true);
  const fetch=async()=>{if(!orgId)return;setLoading(true);const{data}=await supabase.from('projects').select('*,resources(*),vendor_services(*),other_costs(*)').eq('organization_id',orgId).order('created_at');setProjects(data||[]);setLoading(false)};
  React.useEffect(()=>{fetch()},[orgId]);
  const create=async(p)=>{const{data,error}=await supabase.from('projects').insert({...p,organization_id:orgId}).select().single();if(error)throw error;setProjects(prev=>[...prev,{...data,resources:[],vendor_services:[],other_costs:[]}]);return data};
  const del=async(id)=>{const{error}=await supabase.from('projects').delete().eq('id',id);if(error)throw error;setProjects(prev=>prev.filter(p=>p.id!==id))};
  const addRes=async(pid,r)=>{const{data,error}=await supabase.from('resources').insert({...r,project_id:pid}).select().single();if(error)throw error;setProjects(prev=>prev.map(p=>p.id===pid?{...p,resources:[...(p.resources||[]),data]}:p));return data};
  const updateRes=async(pid,rid,u)=>{const{error}=await supabase.from('resources').update(u).eq('id',rid);if(error)throw error;setProjects(prev=>prev.map(p=>p.id===pid?{...p,resources:p.resources.map(r=>r.id===rid?{...r,...u}:r)}:p))};
  const delRes=async(pid,rid)=>{await supabase.from('resources').delete().eq('id',rid);setProjects(prev=>prev.map(p=>p.id===pid?{...p,resources:p.resources.filter(r=>r.id!==rid)}:p))};
  const addVen=async(pid,v)=>{const{data,error}=await supabase.from('vendor_services').insert({...v,project_id:pid}).select().single();if(error)throw error;setProjects(prev=>prev.map(p=>p.id===pid?{...p,vendor_services:[...(p.vendor_services||[]),data]}:p))};
  const updateVen=async(pid,vid,u)=>{const{error}=await supabase.from('vendor_services').update(u).eq('id',vid);if(error)throw error;setProjects(prev=>prev.map(p=>p.id===pid?{...p,vendor_services:p.vendor_services.map(v=>v.id===vid?{...v,...u}:v)}:p))};
  const delVen=async(pid,vid)=>{await supabase.from('vendor_services').delete().eq('id',vid);setProjects(prev=>prev.map(p=>p.id===pid?{...p,vendor_services:p.vendor_services.filter(v=>v.id!==vid)}:p))};
  const addCost=async(pid,c)=>{const{data,error}=await supabase.from('other_costs').insert({...c,project_id:pid}).select().single();if(error)throw error;setProjects(prev=>prev.map(p=>p.id===pid?{...p,other_costs:[...(p.other_costs||[]),data]}:p))};
  const updateCost=async(pid,cid,u)=>{const{error}=await supabase.from('other_costs').update(u).eq('id',cid);if(error)throw error;setProjects(prev=>prev.map(p=>p.id===pid?{...p,other_costs:p.other_costs.map(c=>c.id===cid?{...c,...u}:c)}:p))};
  const delCost=async(pid,cid)=>{await supabase.from('other_costs').delete().eq('id',cid);setProjects(prev=>prev.map(p=>p.id===pid?{...p,other_costs:p.other_costs.filter(c=>c.id!==cid)}:p))};
  return{projects,loading,create,del,addRes,updateRes,delRes,addVen,updateVen,delVen,addCost,updateCost,delCost,refresh:fetch};
};

const useTeam=(orgId)=>{
  const[members,setMembers]=React.useState([]);
  const[invites,setInvites]=React.useState([]);
  const fetch=async()=>{if(!orgId)return;const{data:m}=await supabase.from('organization_members').select('*,profiles(*)').eq('organization_id',orgId);setMembers(m||[]);const{data:i}=await supabase.from('invitations').select('*').eq('organization_id',orgId).eq('status','pending');setInvites(i||[])};
  React.useEffect(()=>{fetch()},[orgId]);
  const invite=async(email,role='member')=>{const{data,error}=await supabase.from('invitations').insert({organization_id:orgId,email,role,status:'pending'}).select().single();if(error)throw error;setInvites(prev=>[...prev,data]);return data};
  const cancelInvite=async(id)=>{await supabase.from('invitations').delete().eq('id',id);setInvites(prev=>prev.filter(i=>i.id!==id))};
  const removeMember=async(uid)=>{await supabase.from('organization_members').delete().eq('organization_id',orgId).eq('user_id',uid);setMembers(prev=>prev.filter(m=>m.user_id!==uid))};
  return{members,invites,invite,cancelInvite,removeMember,refresh:fetch};
};

const Modal=({open,onClose,title,children,wide})=>{if(!open)return null;return<div style={{position:'fixed',inset:0,background:'rgba(0,0,0,.9)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:1000,padding:16}} onClick={onClose}><div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,width:'100%',maxWidth:wide?700:500,maxHeight:'90vh',overflow:'auto'}} onClick={e=>e.stopPropagation()}><div style={{padding:'20px 24px',borderBottom:`1px solid ${C.border}`,display:'flex',justifyContent:'space-between',alignItems:'center',position:'sticky',top:0,background:C.card}}><h3 style={{margin:0,fontSize:18,fontWeight:600}}>{title}</h3><button onClick={onClose} style={{background:'transparent',border:'none',color:C.textS,fontSize:24,cursor:'pointer'}}>√ó</button></div><div style={{padding:24}}>{children}</div></div></div>};
const Btn=({children,onClick,v='primary',disabled,style,...p})=>{const S={primary:{background:C.text,color:C.bg},secondary:{background:'transparent',color:C.text,border:`1px solid ${C.border}`},danger:{background:C.err,color:'#fff'}};return<button onClick={onClick} disabled={disabled} style={{padding:'12px 24px',borderRadius:6,fontSize:14,fontWeight:600,cursor:disabled?'not-allowed':'pointer',opacity:disabled?.5:1,border:'none',...S[v],...style}} {...p}>{children}</button>};
const Input=({label,...p})=><div style={{marginBottom:16}}>{label&&<label style={{fontSize:12,color:C.textM,marginBottom:6,display:'block',textTransform:'uppercase',letterSpacing:.5}}>{label}</label>}<input {...p} style={{width:'100%',padding:12,background:C.bg,border:`1px solid ${C.border}`,borderRadius:6,color:C.text,fontSize:14,...p.style}}/></div>;
const Select=({label,children,...p})=><div style={{marginBottom:16}}>{label&&<label style={{fontSize:12,color:C.textM,marginBottom:6,display:'block',textTransform:'uppercase',letterSpacing:.5}}>{label}</label>}<select {...p} style={{width:'100%',padding:12,background:C.bg,border:`1px solid ${C.border}`,borderRadius:6,color:C.text,fontSize:14,...p.style}}>{children}</select></div>;

const RBar=({r,idx,periods,onUpd,onDel,onEdit,color,showAll})=>{
  const ref=React.useRef(null);
  const[drag,setDrag]=React.useState(false);
  const[resize,setResize]=React.useState(null);
  const[start,setStart]=React.useState({x:0,sp:0,dur:0,pw:0});
  const down=(e,type)=>{e.preventDefault();e.stopPropagation();if(showAll)return;const rect=ref.current.parentElement.getBoundingClientRect();setStart({x:e.clientX,sp:r.start_period,dur:r.duration_periods,pw:rect.width/periods});if(type==='move')setDrag(true);else setResize(type)};
  React.useEffect(()=>{if(!drag&&!resize)return;const move=e=>{const dx=e.clientX-start.x;const dp=Math.round(dx/start.pw);if(drag){const ns=Math.max(0,Math.min(periods-start.dur,start.sp+dp));if(ns!==r.start_period)onUpd(r.id,{start_period:ns})}else if(resize==='left'){const ns=Math.max(0,Math.min(start.sp+start.dur-1,start.sp+dp));const nd=start.dur-(ns-start.sp);if(ns!==r.start_period||nd!==r.duration_periods)onUpd(r.id,{start_period:ns,duration_periods:nd})}else if(resize==='right'){const nd=Math.max(1,Math.min(periods-start.sp,start.dur+dp));if(nd!==r.duration_periods)onUpd(r.id,{duration_periods:nd})}};const up=()=>{setDrag(false);setResize(null)};window.addEventListener('mousemove',move);window.addEventListener('mouseup',up);return()=>{window.removeEventListener('mousemove',move);window.removeEventListener('mouseup',up)}},[drag,resize,start,r,periods,onUpd]);
  return<div ref={ref} className={`rbar${drag?' drag':''}`} style={{top:`${idx*54+10}px`,left:`${(r.start_period/periods)*100}%`,width:`${(r.duration_periods/periods)*100}%`,background:`${color}20`,border:`1px solid ${color}`}} onMouseDown={e=>down(e,'move')} onDoubleClick={()=>!showAll&&onEdit(r)}>
    {!showAll&&<div className="rh rh-l" onMouseDown={e=>down(e,'left')}/>}
    <div style={{display:'flex',alignItems:'center',gap:6,overflow:'hidden',flex:1,paddingLeft:showAll?0:8}}><span style={{fontSize:12,fontWeight:500,whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis'}}>{r.name}</span>{r.quantity>1&&<span style={{background:color,color:'#fff',fontSize:9,fontWeight:600,padding:'2px 5px',borderRadius:3}}>√ó{r.quantity}</span>}<span style={{background:r.employment_type==='fte'?`${C.fte}40`:`${C.con}40`,color:r.employment_type==='fte'?C.fte:C.con,fontSize:9,fontWeight:600,padding:'2px 5px',borderRadius:3}}>{r.employment_type==='fte'?'FTE':'CON'}</span></div>
    <div style={{display:'flex',alignItems:'center',gap:8,flexShrink:0,paddingRight:showAll?0:8}}><span style={{fontSize:11,fontWeight:600,color}}>{fmt(cCost(r))}</span>{!showAll&&<button onClick={e=>{e.stopPropagation();onDel(r.id)}} style={{background:'transparent',border:'none',color:C.textM,cursor:'pointer',fontSize:14}}>√ó</button>}</div>
    {!showAll&&<div className="rh rh-r" onMouseDown={e=>down(e,'right')}/>}
  </div>;
};

const Landing=({onStart})=>{const{mob}=useWin();return<div style={{minHeight:'100vh',background:C.bg}}><nav style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:mob?'16px 20px':'20px 48px',borderBottom:`1px solid ${C.border}`}}><div style={{display:'flex',alignItems:'center',gap:8}}><span style={{fontSize:mob?16:20,fontWeight:600}}>Portfolio Planner</span>{!mob&&<span style={{fontSize:12,color:C.textM,padding:'4px 8px',border:`1px solid ${C.border}`,borderRadius:4}}>by Chesapeake Systems</span>}</div><Btn onClick={onStart}>Sign In</Btn></nav><section style={{padding:mob?'60px 20px':'100px 48px',textAlign:'center',maxWidth:900,margin:'0 auto'}}><h1 style={{fontSize:mob?32:52,fontWeight:600,lineHeight:1.15,marginBottom:24,letterSpacing:-1}}>Plan resources. Control costs.<br/>Deliver with confidence.</h1><p style={{fontSize:mob?16:18,color:C.textS,maxWidth:700,margin:'0 auto 48px',lineHeight:1.7}}>Complete visibility into project costs, FTE and consultant time allocation, CAPEX and OPEX‚Äîfor one project or an entire portfolio.</p><Btn onClick={onStart} style={{padding:'16px 40px',fontSize:16}}>Start Free Trial</Btn><p style={{fontSize:14,color:C.textM,marginTop:16}}>14-day free trial ¬∑ No credit card required</p></section><footer style={{padding:'40px 20px',borderTop:`1px solid ${C.border}`,textAlign:'center'}}><div style={{color:C.textM,fontSize:14}}>¬© 2025 Chesapeake Systems</div></footer></div>};

const AuthPage=({onBack})=>{const{signIn,signUp,resetPw}=useAuth();const[mode,setMode]=React.useState('signin');const[email,setEmail]=React.useState('');const[pw,setPw]=React.useState('');const[name,setName]=React.useState('');const[err,setErr]=React.useState('');const[ok,setOk]=React.useState('');const[loading,setLoading]=React.useState(false);const submit=async e=>{e.preventDefault();setErr('');setOk('');setLoading(true);try{if(mode==='signup'){await signUp(email,pw,name);setOk('Check email to confirm')}else if(mode==='forgot'){await resetPw(email);setOk('Reset link sent!')}else await signIn(email,pw)}catch(e){setErr(e.message)}setLoading(false)};return<div style={{minHeight:'100vh',background:C.bg,display:'flex',alignItems:'center',justifyContent:'center',padding:20}}><div style={{width:'100%',maxWidth:400}}><div style={{textAlign:'center',marginBottom:32}}><h1 style={{fontSize:24,fontWeight:600,marginBottom:8}}>Portfolio Planner</h1><p style={{color:C.textS,fontSize:14}}>{mode==='signin'?'Sign in':mode==='signup'?'Create account':'Reset password'}</p></div><div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:32}}>{err&&<div style={{background:`${C.err}20`,border:`1px solid ${C.err}`,borderRadius:6,padding:12,marginBottom:16,fontSize:14,color:C.err}}>{err}</div>}{ok&&<div style={{background:`${C.ok}20`,border:`1px solid ${C.ok}`,borderRadius:6,padding:12,marginBottom:16,fontSize:14,color:C.ok}}>{ok}</div>}<form onSubmit={submit}>{mode==='signup'&&<Input label="Name" value={name} onChange={e=>setName(e.target.value)} placeholder="John Smith" required/>}<Input label="Email" type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="you@company.com" required/>{mode!=='forgot'&&<Input label="Password" type="password" value={pw} onChange={e=>setPw(e.target.value)} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minLength={6}/>}<Btn type="submit" disabled={loading} style={{width:'100%',marginTop:8}}>{loading?'...':mode==='signin'?'Sign In':mode==='signup'?'Create':'Send Reset'}</Btn></form><div style={{marginTop:24,textAlign:'center'}}>{mode==='signin'&&<><p style={{color:C.textS,fontSize:14,marginBottom:8}}><button onClick={()=>{setMode('forgot');setErr('');setOk('')}} style={{background:'none',border:'none',color:C.text,textDecoration:'underline',cursor:'pointer',fontSize:14}}>Forgot password?</button></p><p style={{color:C.textS,fontSize:14}}>No account? <button onClick={()=>{setMode('signup');setErr('');setOk('')}} style={{background:'none',border:'none',color:C.text,textDecoration:'underline',cursor:'pointer',fontSize:14}}>Sign up</button></p></>}{mode!=='signin'&&<p style={{color:C.textS,fontSize:14}}><button onClick={()=>{setMode('signin');setErr('');setOk('')}} style={{background:'none',border:'none',color:C.text,textDecoration:'underline',cursor:'pointer',fontSize:14}}>Back to sign in</button></p>}</div></div><div style={{textAlign:'center',marginTop:24}}><button onClick={onBack} style={{background:'none',border:'none',color:C.textM,cursor:'pointer',fontSize:14}}>‚Üê Home</button></div></div></div>};

const Onboarding=()=>{const{createOrg,profile,signOut}=useAuth();const{mob}=useWin();const[name,setName]=React.useState('');const[loading,setLoading]=React.useState(false);const[err,setErr]=React.useState('');const submit=async e=>{e.preventDefault();if(!name.trim())return;setLoading(true);setErr('');try{await createOrg(name.trim())}catch(e){setErr(e.message);setLoading(false)}};return<div style={{minHeight:'100vh',background:C.bg}}><nav style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:mob?'16px 20px':'20px 48px',borderBottom:`1px solid ${C.border}`}}><button onClick={signOut} style={{background:'none',border:'none',cursor:'pointer',display:'flex',alignItems:'center',gap:8}}><span style={{fontSize:mob?16:20,fontWeight:600,color:C.text}}>Portfolio Planner</span>{!mob&&<span style={{fontSize:12,color:C.textM,padding:'4px 8px',border:`1px solid ${C.border}`,borderRadius:4}}>by Chesapeake Systems</span>}</button><Btn v="secondary" onClick={signOut} style={{padding:'8px 16px'}}>Sign Out</Btn></nav><div style={{display:'flex',alignItems:'center',justifyContent:'center',padding:20,minHeight:'calc(100vh - 73px)'}}><div style={{width:'100%',maxWidth:400,textAlign:'center'}}><h1 style={{fontSize:24,fontWeight:600,marginBottom:8}}>Welcome{profile?.full_name?`, ${profile.full_name}`:''}!</h1><p style={{color:C.textS,fontSize:14,marginBottom:32}}>Set up your organization.</p><div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:32,textAlign:'left'}}>{err&&<div style={{background:`${C.err}20`,border:`1px solid ${C.err}`,borderRadius:6,padding:12,marginBottom:16,fontSize:14,color:C.err}}>{err}</div>}<form onSubmit={submit}><Input label="Organization Name" value={name} onChange={e=>setName(e.target.value)} placeholder="Acme Healthcare" required/><Btn type="submit" disabled={loading||!name.trim()} style={{width:'100%'}}>{loading?'Creating...':'Create'}</Btn></form></div></div></div></div>};

const MainApp=()=>{
  const{user,profile,org,signOut}=useAuth();
  const{mob,tab}=useWin();
  const{projects,loading:pL,create,del,addRes,updateRes,delRes,addVen,updateVen,delVen,addCost,updateCost,delCost}=useProjects(org?.id);
  const{members,invites,invite,cancelInvite,removeMember}=useTeam(org?.id);
  const[aPid,setAPid]=React.useState(null);
  const[view,setView]=React.useState('planner');
  const[periods,setPeriods]=React.useState(12);
  const[showAll,setShowAll]=React.useState(false);
  const[modal,setModal]=React.useState(null);
  const[edit,setEdit]=React.useState(null);
  const[saving,setSaving]=React.useState(false);
  const[mobMenu,setMobMenu]=React.useState(false);
  const[delPid,setDelPid]=React.useState(null);
  const emptyRes={type_id:'developer',name:'',rate:150,quantity:1,duration_periods:3,allocation:100,employment_type:'fte',cost_type:'capex',start_period:0};
  const emptyVen={vendor:'',description:'',contract_type:'fixed',amount:0,cost_type:'capex',timing:'lump',duration:12};
  const emptyCost={category:'software',name:'',vendor:'',amount:0,cost_type:'capex',timing:'lump',frequency:'annual',duration:1};
  const[nProj,setNProj]=React.useState({name:'',fy:'FY2025'});
  const[nRes,setNRes]=React.useState(emptyRes);
  const[nVen,setNVen]=React.useState(emptyVen);
  const[nCost,setNCost]=React.useState(emptyCost);
  const[invEmail,setInvEmail]=React.useState('');
  const[invRole,setInvRole]=React.useState('member');
  React.useEffect(()=>{if(projects.length&&!aPid)setAPid(projects[0].id)},[projects]);
  const aP=projects.find(p=>p.id===aPid);
  const getT=p=>{if(!p)return{fte:0,con:0,ven:0,oth:0,tot:0,capex:0,opex:0,fteH:0,conH:0};const res=p.resources||[];const vens=p.vendor_services||[];const oths=p.other_costs||[];const fteR=res.filter(r=>r.employment_type==='fte');const conR=res.filter(r=>r.employment_type==='consultant');const fte=fteR.reduce((s,r)=>s+cCost(r),0);const con=conR.reduce((s,r)=>s+cCost(r),0);const ven=vens.reduce((s,v)=>s+(v.timing==='recurring'?v.amount*v.duration:v.amount),0);const oth=oths.reduce((s,c)=>s+(c.timing==='recurring'?c.amount*c.duration:c.amount),0);const items=[...fteR.map(r=>({ct:r.cost_type,a:cCost(r)})),...conR.map(r=>({ct:r.cost_type,a:cCost(r)})),...vens.map(v=>({ct:v.cost_type,a:v.timing==='recurring'?v.amount*v.duration:v.amount})),...oths.map(c=>({ct:c.cost_type,a:c.timing==='recurring'?c.amount*c.duration:c.amount}))];const capex=items.filter(i=>i.ct==='capex').reduce((s,i)=>s+i.a,0);const opex=items.filter(i=>i.ct==='opex').reduce((s,i)=>s+i.a,0);return{fte,con,ven,oth,tot:fte+con+ven+oth,capex,opex,fteH:fteR.reduce((s,r)=>s+cHrs(r),0),conH:conR.reduce((s,r)=>s+cHrs(r),0)}};
  const T=showAll?projects.reduce((a,p)=>{const t=getT(p);return Object.keys(a).reduce((x,k)=>({...x,[k]:a[k]+t[k]}),{})},{fte:0,con:0,ven:0,oth:0,tot:0,capex:0,opex:0,fteH:0,conH:0}):getT(aP);
  const doCreateProj=async()=>{if(!nProj.name.trim())return;setSaving(true);try{const p=await create({name:nProj.name.trim(),fiscal_year:nProj.fy,color:PCOLS[projects.length%PCOLS.length],start_date:new Date().toISOString().split('T')[0],created_by:user.id});setAPid(p.id);setShowAll(false);setModal(null);setNProj({name:'',fy:'FY2025'})}catch(e){alert(e.message)}setSaving(false)};
  const doDelProj=async()=>{if(!delPid)return;setSaving(true);try{await del(delPid);setDelPid(null);if(aPid===delPid)setAPid(projects.find(p=>p.id!==delPid)?.id||null)}catch(e){alert(e.message)}setSaving(false)};
  const doSaveRes=async()=>{if(!aP||!nRes.name.trim())return;setSaving(true);try{if(edit)await updateRes(aP.id,edit.id,nRes);else await addRes(aP.id,nRes);setModal(null);setEdit(null);setNRes(emptyRes)}catch(e){alert(e.message)}setSaving(false)};
  const doSaveVen=async()=>{if(!aP||!nVen.vendor.trim())return;setSaving(true);try{if(edit)await updateVen(aP.id,edit.id,nVen);else await addVen(aP.id,nVen);setModal(null);setEdit(null);setNVen(emptyVen)}catch(e){alert(e.message)}setSaving(false)};
  const doSaveCost=async()=>{if(!aP||!nCost.name.trim())return;setSaving(true);try{if(edit)await updateCost(aP.id,edit.id,nCost);else await addCost(aP.id,nCost);setModal(null);setEdit(null);setNCost(emptyCost)}catch(e){alert(e.message)}setSaving(false)};
  const doInvite=async()=>{if(!invEmail.trim())return;setSaving(true);try{await invite(invEmail.trim(),invRole);setInvEmail('');alert('Invitation created!')}catch(e){alert(e.message)}setSaving(false)};
  const openEditRes=r=>{setEdit(r);setNRes({type_id:r.type_id,name:r.name,rate:r.rate,quantity:r.quantity,duration_periods:r.duration_periods,allocation:r.allocation,employment_type:r.employment_type,cost_type:r.cost_type,start_period:r.start_period});setModal('addRes')};
  const openEditVen=v=>{setEdit(v);setNVen({vendor:v.vendor,description:v.description||'',contract_type:v.contract_type,amount:v.amount,cost_type:v.cost_type,timing:v.timing,duration:v.duration||12});setModal('addVen')};
  const openEditCost=c=>{setEdit(c);setNCost({category:c.category,name:c.name,vendor:c.vendor||'',amount:c.amount,cost_type:c.cost_type,timing:c.timing,frequency:c.frequency||'annual',duration:c.duration||1});setModal('addCost')};
  const exportCSV=()=>{const rows=[['Category','Amount'],['FTE',T.fte],['Consultants',T.con],['Vendors',T.ven],['Other',T.oth],['TOTAL',T.tot],[],['CAPEX',T.capex],['OPEX',T.opex]];const blob=new Blob([rows.map(r=>r.join(',')).join('\n')],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`budget_${new Date().toISOString().split('T')[0]}.csv`;a.click()};
  const pArr=Array.from({length:periods},(_,i)=>i);
  const startD=aP?.start_date?new Date(aP.start_date):new Date();
  const getD=i=>addM(startD,i);
  const allRes=showAll?projects.flatMap(p=>(p.resources||[]).map(r=>({...r,pCol:p.color}))):(aP?.resources||[]);
  if(pL)return<div className="loading"><div className="spinner"></div><span style={{color:'#666'}}>Loading...</span></div>;

  return<div style={{minHeight:'100vh',background:C.bg}}>
    <Modal open={!!delPid} onClose={()=>setDelPid(null)} title="Delete Project"><p style={{marginBottom:24,color:C.textS}}>Delete this project and all its data? This cannot be undone.</p><div style={{display:'flex',gap:12}}><Btn v="secondary" onClick={()=>setDelPid(null)} style={{flex:1}}>Cancel</Btn><Btn v="danger" onClick={doDelProj} disabled={saving} style={{flex:1}}>{saving?'...':'Delete'}</Btn></div></Modal>
    <Modal open={modal==='report'} onClose={()=>setModal(null)} title="Report"><div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12,marginBottom:24}}>{[{l:'Total',v:T.tot,c:C.text},{l:'CAPEX',v:T.capex,c:C.capex},{l:'OPEX',v:T.opex,c:C.opex},{l:'Hours',v:`${(T.fteH+T.conH).toLocaleString()}h`,c:C.fte}].map((i,k)=><div key={k} style={{background:C.bg,padding:12,borderRadius:6}}><div style={{fontSize:11,color:C.textM,textTransform:'uppercase'}}>{i.l}</div><div style={{fontSize:18,fontWeight:600,color:i.c}}>{typeof i.v==='number'?fmt(i.v):i.v}</div></div>)}</div><Btn onClick={exportCSV} style={{width:'100%'}}>Export CSV</Btn></Modal>
    <Modal open={modal==='team'} onClose={()=>setModal(null)} title="Team" wide><div style={{marginBottom:24}}><h4 style={{fontSize:14,color:C.textM,marginBottom:16,textTransform:'uppercase'}}>Invite</h4><div style={{display:'flex',gap:12,flexWrap:'wrap'}}><input type="email" value={invEmail} onChange={e=>setInvEmail(e.target.value)} placeholder="email@company.com" style={{flex:1,minWidth:200,padding:12,background:C.bg,border:`1px solid ${C.border}`,borderRadius:6,color:C.text,fontSize:14}}/><select value={invRole} onChange={e=>setInvRole(e.target.value)} style={{padding:12,background:C.bg,border:`1px solid ${C.border}`,borderRadius:6,color:C.text}}><option value="member">Member</option><option value="admin">Admin</option><option value="viewer">Viewer</option></select><Btn onClick={doInvite} disabled={saving||!invEmail.trim()}>Invite</Btn></div></div>{invites.length>0&&<div style={{marginBottom:24}}><h4 style={{fontSize:14,color:C.textM,marginBottom:16,textTransform:'uppercase'}}>Pending ({invites.length})</h4>{invites.map(inv=><div key={inv.id} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'12px 0',borderBottom:`1px solid ${C.border}`}}><span>{inv.email} ({inv.role})</span><button onClick={()=>cancelInvite(inv.id)} style={{background:'none',border:'none',color:C.err,cursor:'pointer'}}>Cancel</button></div>)}</div>}<div><h4 style={{fontSize:14,color:C.textM,marginBottom:16,textTransform:'uppercase'}}>Members ({members.length})</h4>{members.map(m=><div key={m.user_id} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'12px 0',borderBottom:`1px solid ${C.border}`}}><div><span>{m.profiles?.full_name||m.profiles?.email}</span><span style={{marginLeft:8,fontSize:12,color:C.textM}}>{m.profiles?.email}</span></div><div style={{display:'flex',alignItems:'center',gap:12}}><span style={{fontSize:12,padding:'4px 8px',background:m.role==='owner'?`${C.ok}20`:C.bg,color:m.role==='owner'?C.ok:C.textS,borderRadius:4}}>{m.role}</span>{m.role!=='owner'&&m.user_id!==user.id&&<button onClick={()=>removeMember(m.user_id)} style={{background:'none',border:'none',color:C.err,cursor:'pointer',fontSize:13}}>Remove</button>}</div></div>)}</div></Modal>
    <Modal open={modal==='newProj'} onClose={()=>setModal(null)} title="New Project"><Input label="Name" value={nProj.name} onChange={e=>setNProj({...nProj,name:e.target.value})} placeholder="Project name"/><Select label="Fiscal Year" value={nProj.fy} onChange={e=>setNProj({...nProj,fy:e.target.value})}>{FYS.map(f=><option key={f} value={f}>{f}</option>)}</Select><Btn onClick={doCreateProj} disabled={saving||!nProj.name.trim()} style={{width:'100%'}}>{saving?'...':'Create'}</Btn></Modal>
    <Modal open={modal==='addRes'} onClose={()=>{setModal(null);setEdit(null);setNRes(emptyRes)}} title={edit?'Edit Resource':'Add Resource'}><Select label="Type" value={nRes.type_id} onChange={e=>{const t=RTS.find(r=>r.id===e.target.value);setNRes({...nRes,type_id:e.target.value,rate:edit?nRes.rate:(t?.rate||150)})}}>{RTS.map(t=><option key={t.id} value={t.id}>{t.name}</option>)}</Select><Input label="Name" value={nRes.name} onChange={e=>setNRes({...nRes,name:e.target.value})} placeholder="Senior Developer"/><div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}><Input label="Rate/hr" type="number" value={nRes.rate} onChange={e=>setNRes({...nRes,rate:+e.target.value})}/><Input label="Qty" type="number" value={nRes.quantity} onChange={e=>setNRes({...nRes,quantity:+e.target.value})}/></div><div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}><Input label="Start" type="number" value={nRes.start_period} onChange={e=>setNRes({...nRes,start_period:+e.target.value})}/><Input label="Duration" type="number" value={nRes.duration_periods} onChange={e=>setNRes({...nRes,duration_periods:+e.target.value})}/></div><div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}><Select label="Allocation" value={nRes.allocation} onChange={e=>setNRes({...nRes,allocation:+e.target.value})}><option value={100}>100%</option><option value={75}>75%</option><option value={50}>50%</option><option value={25}>25%</option></Select><Select label="Type" value={nRes.employment_type} onChange={e=>setNRes({...nRes,employment_type:e.target.value})}><option value="fte">FTE</option><option value="consultant">Consultant</option></Select></div><Select label="Cost" value={nRes.cost_type} onChange={e=>setNRes({...nRes,cost_type:e.target.value})}><option value="capex">CAPEX</option><option value="opex">OPEX</option></Select><div style={{background:C.bg,padding:12,borderRadius:6,marginBottom:16,textAlign:'center'}}><span style={{fontSize:12,color:C.textM}}>Est: </span><span style={{fontSize:18,fontWeight:600}}>{fmt(nRes.rate*nRes.duration_periods*HPM*nRes.quantity*(nRes.allocation/100))}</span></div><Btn onClick={doSaveRes} disabled={saving||!nRes.name.trim()} style={{width:'100%'}}>{saving?'...':(edit?'Save':'Add')}</Btn></Modal>
    <Modal open={modal==='addVen'} onClose={()=>{setModal(null);setEdit(null);setNVen(emptyVen)}} title={edit?'Edit Vendor':'Add Vendor'}><Input label="Vendor" value={nVen.vendor} onChange={e=>setNVen({...nVen,vendor:e.target.value})} placeholder="Deloitte"/><Input label="Description" value={nVen.description} onChange={e=>setNVen({...nVen,description:e.target.value})}/><div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}><Select label="Contract" value={nVen.contract_type} onChange={e=>setNVen({...nVen,contract_type:e.target.value})}><option value="fixed">Fixed</option><option value="tm">T&M</option><option value="hybrid">Hybrid</option></Select><Select label="Cost" value={nVen.cost_type} onChange={e=>setNVen({...nVen,cost_type:e.target.value})}><option value="capex">CAPEX</option><option value="opex">OPEX</option></Select></div><Select label="Timing" value={nVen.timing} onChange={e=>setNVen({...nVen,timing:e.target.value})}><option value="lump">Lump Sum</option><option value="recurring">Recurring</option></Select>{nVen.timing==='recurring'?<div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}><Input label="$/mo" type="number" value={nVen.amount} onChange={e=>setNVen({...nVen,amount:+e.target.value})}/><Input label="Months" type="number" value={nVen.duration} onChange={e=>setNVen({...nVen,duration:+e.target.value})}/></div>:<Input label="Amount" type="number" value={nVen.amount} onChange={e=>setNVen({...nVen,amount:+e.target.value})}/>}<div style={{background:C.bg,padding:12,borderRadius:6,marginBottom:16,textAlign:'center'}}><span style={{fontSize:12,color:C.textM}}>Total: </span><span style={{fontSize:18,fontWeight:600}}>{fmt(nVen.timing==='recurring'?nVen.amount*nVen.duration:nVen.amount)}</span></div><Btn onClick={doSaveVen} disabled={saving||!nVen.vendor.trim()} style={{width:'100%'}}>{saving?'...':(edit?'Save':'Add')}</Btn></Modal>
    <Modal open={modal==='addCost'} onClose={()=>{setModal(null);setEdit(null);setNCost(emptyCost)}} title={edit?'Edit Cost':'Add Cost'}><Select label="Category" value={nCost.category} onChange={e=>{const c=CCS.find(x=>x.id===e.target.value);setNCost({...nCost,category:e.target.value,cost_type:edit?nCost.cost_type:(c?.ct||'opex'),timing:edit?nCost.timing:(c?.tm||'lump')})}}>{CCS.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</Select><Input label="Name" value={nCost.name} onChange={e=>setNCost({...nCost,name:e.target.value})} placeholder="Azure"/><Input label="Vendor" value={nCost.vendor} onChange={e=>setNCost({...nCost,vendor:e.target.value})} placeholder="Microsoft"/><div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}><Select label="Cost" value={nCost.cost_type} onChange={e=>setNCost({...nCost,cost_type:e.target.value})}><option value="capex">CAPEX</option><option value="opex">OPEX</option></Select><Select label="Timing" value={nCost.timing} onChange={e=>setNCost({...nCost,timing:e.target.value})}><option value="lump">Lump</option><option value="recurring">Recurring</option></Select></div>{nCost.timing==='recurring'?<div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:12}}><Input label="Amt" type="number" value={nCost.amount} onChange={e=>setNCost({...nCost,amount:+e.target.value})}/><Select label="Freq" value={nCost.frequency} onChange={e=>setNCost({...nCost,frequency:e.target.value})}><option value="monthly">Monthly</option><option value="quarterly">Quarterly</option><option value="annual">Annual</option></Select><Input label="#" type="number" value={nCost.duration} onChange={e=>setNCost({...nCost,duration:+e.target.value})}/></div>:<Input label="Amount" type="number" value={nCost.amount} onChange={e=>setNCost({...nCost,amount:+e.target.value})}/>}<div style={{background:C.bg,padding:12,borderRadius:6,marginBottom:16,textAlign:'center'}}><span style={{fontSize:12,color:C.textM}}>Total: </span><span style={{fontSize:18,fontWeight:600}}>{fmt(nCost.timing==='recurring'?nCost.amount*nCost.duration:nCost.amount)}</span></div><Btn onClick={doSaveCost} disabled={saving||!nCost.name.trim()} style={{width:'100%'}}>{saving?'...':(edit?'Save':'Add')}</Btn></Modal>

    <nav style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:mob?'12px 16px':'16px 32px',borderBottom:`1px solid ${C.border}`}}><div style={{display:'flex',alignItems:'center',gap:8}}><span style={{fontSize:mob?16:18,fontWeight:600}}>Portfolio Planner</span>{!mob&&org&&<span style={{fontSize:12,color:C.textM,padding:'4px 8px',background:C.card,borderRadius:4}}>{org.name}</span>}</div>{mob?<button onClick={()=>setMobMenu(!mobMenu)} style={{background:'transparent',border:'none',color:C.text,fontSize:24,cursor:'pointer'}}>‚ò∞</button>:<div style={{display:'flex',alignItems:'center',gap:12}}><Btn v="secondary" onClick={()=>setModal('team')} style={{padding:'8px 16px'}}>Team</Btn><Btn v="secondary" onClick={()=>setModal('report')} style={{padding:'8px 16px'}}>Report</Btn><span style={{fontSize:13,color:C.textS}}>{profile?.email}</span><Btn v="secondary" onClick={signOut} style={{padding:'8px 16px'}}>Out</Btn></div>}</nav>
    {mob&&mobMenu&&<div style={{padding:16,borderBottom:`1px solid ${C.border}`,background:C.card}}><Btn v="secondary" onClick={()=>{setModal('team');setMobMenu(false)}} style={{width:'100%',marginBottom:8}}>Team</Btn><Btn v="secondary" onClick={()=>{setModal('report');setMobMenu(false)}} style={{width:'100%',marginBottom:8}}>Report</Btn><Btn v="secondary" onClick={signOut} style={{width:'100%'}}>Sign Out</Btn></div>}

    <div style={{padding:mob?16:'24px 32px'}}>
      <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:16,flexWrap:'wrap'}}><button onClick={()=>setShowAll(!showAll)} style={{padding:'8px 12px',border:showAll?`1px solid ${C.text}`:`1px solid ${C.border}`,borderRadius:6,background:showAll?'rgba(255,255,255,.1)':'transparent',color:showAll?C.text:C.textS,cursor:'pointer',fontSize:12,fontWeight:500}}>Portfolio</button>{projects.map(p=><div key={p.id} style={{position:'relative'}}><button onClick={()=>{setAPid(p.id);setShowAll(false)}} style={{padding:'8px 12px',paddingRight:!showAll&&aPid===p.id?32:12,border:!showAll&&aPid===p.id?`1px solid ${p.color}`:`1px solid ${C.border}`,borderRadius:6,background:!showAll&&aPid===p.id?`${p.color}20`:'transparent',color:!showAll&&aPid===p.id?p.color:C.textS,cursor:'pointer',fontSize:12,fontWeight:500,display:'flex',alignItems:'center',gap:6}}><div style={{width:8,height:8,borderRadius:2,background:p.color}}/>{mob?p.name.slice(0,10):p.name}</button>{!showAll&&aPid===p.id&&<button onClick={e=>{e.stopPropagation();setDelPid(p.id)}} style={{position:'absolute',right:6,top:'50%',transform:'translateY(-50%)',background:'transparent',border:'none',color:C.textM,cursor:'pointer',fontSize:14}} title="Delete">√ó</button>}</div>)}<button onClick={()=>setModal('newProj')} style={{padding:'8px 12px',border:`1px dashed ${C.borderL}`,borderRadius:6,background:'transparent',color:C.textM,cursor:'pointer',fontSize:12}}>+ New</button></div>
      {!showAll&&aP&&<div style={{display:'flex',gap:8,marginBottom:16}}><button onClick={()=>setView('planner')} style={{padding:'10px 16px',border:view==='planner'?`1px solid ${C.text}`:`1px solid ${C.border}`,borderRadius:6,background:view==='planner'?'rgba(255,255,255,.1)':'transparent',color:view==='planner'?C.text:C.textS,cursor:'pointer',fontSize:13,fontWeight:500}}>üìÖ Planner</button><button onClick={()=>setView('budget')} style={{padding:'10px 16px',border:view==='budget'?`1px solid ${C.text}`:`1px solid ${C.border}`,borderRadius:6,background:view==='budget'?'rgba(255,255,255,.1)':'transparent',color:view==='budget'?C.text:C.textS,cursor:'pointer',fontSize:13,fontWeight:500}}>üí∞ Budget</button></div>}
      <div style={{display:'grid',gridTemplateColumns:mob?'repeat(2,1fr)':tab?'repeat(3,1fr)':'repeat(5,1fr)',gap:12,marginBottom:20}}>{[{l:'Total',v:fmt(T.tot),c:C.text},{l:'CAPEX',v:fmt(T.capex),c:C.capex},{l:'OPEX',v:fmt(T.opex),c:C.opex},{l:'FTE Hrs',v:`${T.fteH.toLocaleString()}h`,c:C.fte},{l:'Con Hrs',v:`${T.conH.toLocaleString()}h`,c:C.con}].map((d,i)=><div key={i} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:8,padding:12}}><div style={{fontSize:10,color:C.textM,marginBottom:4,textTransform:'uppercase'}}>{d.l}</div><div style={{fontSize:mob?16:20,fontWeight:600,color:d.c}}>{d.v}</div></div>)}</div>

      {(showAll||view==='planner')&&<><div style={{display:'flex',alignItems:'center',gap:12,marginBottom:16,padding:12,background:C.card,borderRadius:8,border:`1px solid ${C.border}`,flexWrap:'wrap'}}><div style={{display:'flex',alignItems:'center',gap:8}}><button onClick={()=>setPeriods(p=>Math.max(4,p-2))} style={{width:28,height:28,border:`1px solid ${C.border}`,borderRadius:6,background:C.bg,color:C.text,cursor:'pointer'}}>‚àí</button><span style={{fontSize:13,minWidth:24,textAlign:'center'}}>{periods}</span><button onClick={()=>setPeriods(p=>Math.min(52,p+2))} style={{width:28,height:28,border:`1px solid ${C.border}`,borderRadius:6,background:C.bg,color:C.text,cursor:'pointer'}}>+</button><span style={{fontSize:12,color:C.textM,marginLeft:4}}>months</span></div>{!showAll&&<span style={{fontSize:12,color:C.textM}}>Drag to move ¬∑ Drag edges to resize ¬∑ Double-click to edit</span>}</div>{!showAll&&aP&&<button onClick={()=>{setEdit(null);setNRes(emptyRes);setModal('addRes')}} style={{marginBottom:16,padding:'10px 16px',background:'transparent',border:`1px solid ${C.border}`,borderRadius:6,color:C.text,fontSize:13,cursor:'pointer'}}>+ Add Resource</button>}<div style={{background:C.card,borderRadius:8,border:`1px solid ${C.border}`,overflow:'hidden',overflowX:'auto'}}><div style={{minWidth:mob?800:'auto'}}><div style={{display:'grid',gridTemplateColumns:`repeat(${periods},1fr)`,borderBottom:`1px solid ${C.border}`}}>{pArr.map((p,i)=><div key={p} style={{padding:'8px 4px',textAlign:'center',fontSize:10,color:C.textM,borderRight:i<pArr.length-1?`1px solid ${C.border}`:'none'}}>{fmtM(getD(p))}</div>)}</div><div style={{position:'relative',minHeight:Math.max(150,allRes.length*54+20),padding:'10px 0'}}>{pArr.map((_,i)=><div key={i} style={{position:'absolute',left:`${(i/periods)*100}%`,top:0,bottom:0,width:1,background:C.border,opacity:.3}}/>)}{allRes.map((r,idx)=>{const t=RTS.find(x=>x.id===r.type_id);const col=showAll?r.pCol:t?.color||'#888';return<RBar key={`${r.pName||''}-${r.id}`} r={r} idx={idx} periods={periods} color={col} showAll={showAll} onUpd={(rid,u)=>updateRes(aP.id,rid,u)} onDel={rid=>delRes(aP.id,rid)} onEdit={openEditRes}/>})}{allRes.length===0&&<div style={{display:'flex',alignItems:'center',justifyContent:'center',height:150,color:C.textM,fontSize:14}}>Add resources to get started</div>}</div></div></div></>}

      {!showAll&&view==='budget'&&aP&&<div style={{display:'flex',flexDirection:'column',gap:16}}>
        <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:8}}><div style={{padding:16,borderBottom:`1px solid ${C.border}`,display:'flex',justifyContent:'space-between'}}><span style={{fontWeight:600}}>FTE Labor</span><span style={{fontWeight:600,color:C.fte}}>{fmt(T.fte)}</span></div><div style={{padding:16}}>{(aP.resources||[]).filter(r=>r.employment_type==='fte').length===0?<p style={{color:C.textM,margin:0}}>No FTE</p>:(aP.resources||[]).filter(r=>r.employment_type==='fte').map(r=><div key={r.id} style={{display:'flex',justifyContent:'space-between',padding:'8px 0',borderBottom:`1px solid ${C.border}`,cursor:'pointer'}} onClick={()=>openEditRes(r)}><span style={{fontSize:13}}>{r.name} {r.quantity>1&&`√ó${r.quantity}`}</span><span style={{fontSize:13,color:C.textS}}>{fmt(cCost(r))}</span></div>)}</div></div>
        <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:8}}><div style={{padding:16,borderBottom:`1px solid ${C.border}`,display:'flex',justifyContent:'space-between'}}><span style={{fontWeight:600}}>Consultants</span><span style={{fontWeight:600,color:C.con}}>{fmt(T.con)}</span></div><div style={{padding:16}}>{(aP.resources||[]).filter(r=>r.employment_type==='consultant').length===0?<p style={{color:C.textM,margin:0}}>No consultants</p>:(aP.resources||[]).filter(r=>r.employment_type==='consultant').map(r=><div key={r.id} style={{display:'flex',justifyContent:'space-between',padding:'8px 0',borderBottom:`1px solid ${C.border}`,cursor:'pointer'}} onClick={()=>openEditRes(r)}><span style={{fontSize:13}}>{r.name} {r.quantity>1&&`√ó${r.quantity}`}</span><span style={{fontSize:13,color:C.textS}}>{fmt(cCost(r))}</span></div>)}</div></div>
        <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:8}}><div style={{padding:16,borderBottom:`1px solid ${C.border}`,display:'flex',justifyContent:'space-between',alignItems:'center'}}><span style={{fontWeight:600}}>Vendors</span><div style={{display:'flex',gap:12,alignItems:'center'}}><span style={{fontWeight:600,color:'#8b5cf6'}}>{fmt(T.ven)}</span><button onClick={()=>{setEdit(null);setNVen(emptyVen);setModal('addVen')}} style={{padding:'6px 12px',background:'transparent',border:`1px solid ${C.border}`,borderRadius:4,color:C.text,fontSize:12,cursor:'pointer'}}>+ Add</button></div></div><div style={{padding:16}}>{(aP.vendor_services||[]).length===0?<p style={{color:C.textM,margin:0}}>No vendors</p>:(aP.vendor_services||[]).map(v=><div key={v.id} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'10px 0',borderBottom:`1px solid ${C.border}`,cursor:'pointer'}} onClick={()=>openEditVen(v)}><div><div style={{fontSize:13,fontWeight:500}}>{v.vendor}</div><div style={{fontSize:12,color:C.textM}}>{v.description}</div></div><div style={{display:'flex',gap:12,alignItems:'center'}}><span style={{fontSize:13,fontWeight:500}}>{fmt(v.timing==='recurring'?v.amount*v.duration:v.amount)}</span><button onClick={e=>{e.stopPropagation();delVen(aP.id,v.id)}} style={{background:'transparent',border:'none',color:C.textM,cursor:'pointer'}}>√ó</button></div></div>)}</div></div>
        <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:8}}><div style={{padding:16,borderBottom:`1px solid ${C.border}`,display:'flex',justifyContent:'space-between',alignItems:'center'}}><span style={{fontWeight:600}}>Other Costs</span><div style={{display:'flex',gap:12,alignItems:'center'}}><span style={{fontWeight:600}}>{fmt(T.oth)}</span><button onClick={()=>{setEdit(null);setNCost(emptyCost);setModal('addCost')}} style={{padding:'6px 12px',background:'transparent',border:`1px solid ${C.border}`,borderRadius:4,color:C.text,fontSize:12,cursor:'pointer'}}>+ Add</button></div></div><div style={{padding:16}}>{(aP.other_costs||[]).length===0?<p style={{color:C.textM,margin:0}}>No other costs</p>:(aP.other_costs||[]).map(c=>{const cat=CCS.find(x=>x.id===c.category);return<div key={c.id} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'10px 0',borderBottom:`1px solid ${C.border}`,cursor:'pointer'}} onClick={()=>openEditCost(c)}><div><div style={{fontSize:13,fontWeight:500}}>{c.name}</div><div style={{fontSize:12,color:C.textM}}>{cat?.name}{c.vendor&&` ¬∑ ${c.vendor}`}</div></div><div style={{display:'flex',gap:12,alignItems:'center'}}><span style={{fontSize:13,fontWeight:500}}>{fmt(c.timing==='recurring'?c.amount*c.duration:c.amount)}</span><button onClick={e=>{e.stopPropagation();delCost(aP.id,c.id)}} style={{background:'transparent',border:'none',color:C.textM,cursor:'pointer'}}>√ó</button></div></div>})}</div></div>
      </div>}
    </div>
  </div>;
};

const App=()=>{const{user,org,loading}=useAuth();const[page,setPage]=React.useState('landing');React.useEffect(()=>{if(window.location.hash.includes('type=recovery'))setPage('auth')},[]);if(loading)return<div className="loading"><div className="spinner"></div></div>;if(user&&!org)return<Onboarding/>;if(user&&org)return<MainApp/>;if(page==='auth')return<AuthPage onBack={()=>setPage('landing')}/>;return<Landing onStart={()=>setPage('auth')}/>};
const Root=()=><AuthProvider><App/></AuthProvider>;
ReactDOM.createRoot(document.getElementById('root')).render(<Root/>);
</script>
</body>
</html>
